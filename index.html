<!-- ==================== FRONTEND MEJORADO CON SINCRONIZACI√ìN BIDIRECCIONAL ==================== -->

<script type="module">
    // ... imports existentes de Firebase ...
    
    let registrosJose = [];
    let intervalActualizacion = null;
    let intervalSincronizacionLina = null;
    
    // ==================== SINCRONIZACI√ìN BIDIRECCIONAL MEJORADA ====================
    
    // 1. GUARDAR N√öMERO DE FILA EN FIREBASE al crear registro
    async function guardarFilaEnFirebase(firebaseId, fila, categoria) {
        try {
            const docRef = doc(db, "solicitudes", firebaseId);
            await updateDoc(docRef, {
                _fila: fila,
                _categoria: categoria,
                _ultimaActualizacion: new Date().toISOString()
            });
            console.log("‚úÖ Fila guardada en Firebase:", fila);
        } catch (error) {
            console.error("‚ùå Error al guardar fila:", error);
        }
    }
    
    // 2. CARGAR REGISTROS DESDE GOOGLE SHEETS
    async function cargarRegistrosDesdeSheets(categoria) {
        try {
            const response = await fetch(
                `${urlAppsScript}?action=obtenerRegistros&categoria=${encodeURIComponent(categoria)}`
            );
            const data = await response.json();
            
            if (data && Array.isArray(data)) {
                console.log(`‚úÖ Registros cargados desde Sheets (${categoria}):`, data.length);
                return data;
            }
            return [];
        } catch (error) {
            console.error("‚ùå Error al cargar desde Sheets:", error);
            return [];
        }
    }
    
    // ==================== TABLA DE REGISTROS PARA JOS√â ====================
    
    window.cargarTablaJose = async () => {
        const categoria = document.getElementById('categoria').value;
        if (!categoria) {
            document.getElementById('tabla-registros-jose').innerHTML = 
                '<tr><td colspan="7" class="text-center py-4 text-gray-500">Seleccione una categor√≠a primero</td></tr>';
            return;
        }
        
        try {
            // Cargar desde Firebase
            const q = query(
                collection(db, "solicitudes"),
                where("categoria", "==", categoria),
                orderBy("timestamp", "desc")
            );
            const querySnapshot = await getDocs(q);
            
            const tbody = document.getElementById('tabla-registros-jose');
            tbody.innerHTML = '';
            
            if (querySnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay registros en esta categor√≠a</td></tr>';
                return;
            }
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const estadoColor = data.estado_ciarp === 'Aprobado' ? 'bg-green-100 text-green-800' : 
                                   data.estado_ciarp === 'No Aprobado' ? 'bg-red-100 text-red-800' : 
                                   'bg-yellow-100 text-yellow-800';
                
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="border px-2 py-2 text-xs">${data.anio || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.semestre || ''}</td>
                        <td class="border px-2 py-2 text-xs font-semibold">${data.titulo_producto || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.autor || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.fecha_recibido || ''}</td>
                        <td class="border px-2 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold ${estadoColor}">
                                ${data.estado_ciarp || 'Pendiente'}
                            </span>
                        </td>
                        <td class="border px-2 py-2 text-center">
                            <button onclick="eliminarRegistroJose('${docSnap.id}', '${data._categoria}', ${data._fila})" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-bold">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
        } catch (error) {
            console.error("‚ùå Error al cargar tabla:", error);
            document.getElementById('tabla-registros-jose').innerHTML = 
                '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar registros</td></tr>';
        }
    };
    
    // ==================== ELIMINAR REGISTRO (FIREBASE + SHEETS) ====================
    
    window.eliminarRegistroJose = async (firebaseId, categoria, fila) => {
        if (!confirm('¬øEst√° seguro de eliminar este registro? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        try {
            // 1. Eliminar de Google Sheets
            const response = await fetch(
                `${urlAppsScript}?action=eliminarRegistro&categoria=${encodeURIComponent(categoria)}&fila=${fila}`,
                { method: 'GET' }
            );
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // 2. Eliminar de Firebase
                const docRef = doc(db, "solicitudes", firebaseId);
                await deleteDoc(docRef);
                
                alert(`‚úÖ Registro eliminado: ${result.titulo}`);
                
                // 3. Recargar tabla
                cargarTablaJose();
            } else {
                throw new Error(result.message || 'Error al eliminar de Sheets');
            }
            
        } catch (error) {
            console.error("‚ùå Error al eliminar:", error);
            alert("‚ùå Error al eliminar: " + error.message);
        }
    };
    
    // ==================== ENVIAR SOLICITUD MEJORADA (JOS√â) ====================
    
    window.enviarSolicitud = async () => {
        const categoria = document.getElementById('categoria').value;
        const anio = document.getElementById('anio').value;
        const semestre = document.getElementById('semestre').value;
        const fechaRecibido = document.getElementById('fecha-recibido').value;
        const autor = document.getElementById('autor').value;
        const programa = document.getElementById('programa').value;
        const docCompleta = document.getElementById('doc-completa').value;
        const estadoCiarp = document.getElementById('estado-ciarp').value;
        const observaciones = document.getElementById('observaciones-jose').value;

        if (!categoria || !anio || !semestre || !fechaRecibido || !autor) {
            alert("‚ö†Ô∏è Complete los campos obligatorios");
            return;
        }

        let tituloProducto = '';
        if (categoria.includes("Art√≠culos")) {
            tituloProducto = document.getElementById('nombre_articulo')?.value || '';
        } else if (categoria.includes("Libro")) {
            tituloProducto = document.getElementById('titulo_libro')?.value || '';
        } else if (categoria.includes("Cap√≠tulo")) {
            tituloProducto = document.getElementById('titulo_capitulo')?.value || '';
        }

        if (!tituloProducto) {
            alert("‚ö†Ô∏è Complete el t√≠tulo del producto");
            return;
        }

        const btnEnviar = document.getElementById('btn-enviar-jose');
        btnEnviar.disabled = true;
        btnEnviar.innerText = "‚è≥ ENVIANDO...";

        try {
            // 1. CREAR EN FIREBASE
            const datosFirebase = {
                categoria: categoria,
                anio: anio,
                semestre: semestre,
                fecha_recibido: fechaRecibido,
                titulo_producto: tituloProducto,
                autor: autor,
                programa: programa,
                doc_completa: docCompleta,
                estado_ciarp: estadoCiarp,
                observaciones_jose: observaciones,
                timestamp: new Date().toISOString(),
                tipo_registro: "JOSE"
            };

            const docRef = await addDoc(collection(db, "solicitudes"), datosFirebase);
            console.log("‚úÖ Registro creado en Firebase:", docRef.id);

            // 2. CREAR EN GOOGLE SHEETS
            const datosSheets = {
                ...datosFirebase,
                tipo_registro: "JOSE"
            };

            const response = await fetch(urlAppsScript, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosSheets)
            });

            const result = await response.json();
            
            if (result.status === 'success' && result.fila) {
                // 3. GUARDAR N√öMERO DE FILA EN FIREBASE
                await guardarFilaEnFirebase(docRef.id, result.fila, categoria);
                
                alert("‚úÖ Registro creado y sincronizado correctamente");
                
                // Limpiar formulario
                document.getElementById('form-jose').reset();
                
                // Recargar tabla
                cargarTablaJose();
            } else {
                throw new Error("Error al crear en Sheets");
            }

        } catch (error) {
            console.error("‚ùå Error:", error);
            alert("‚ùå Error al guardar: " + error.message);
        } finally {
            btnEnviar.disabled = false;
            btnEnviar.innerText = "üì§ ENVIAR SOLICITUD";
        }
    };
    
    // ==================== GUARDAR EVALUACI√ìN (LINA) - MEJORADA ====================
    
    window.guardarEvaluacion = async () => {
        const idActual = document.getElementById('modal-id').value;
        
        if (!idActual) {
            alert("‚ö†Ô∏è No se encontr√≥ el ID del documento");
            return;
        }

        const btnGuardar = document.getElementById('btn-guardar-lina');
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="animate-pulse">‚è≥</span> GUARDANDO...';

        try {
            const docRef = doc(db, "solicitudes", idActual);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                throw new Error("Documento no encontrado");
            }

            const datosOriginales = docSnap.data();

            // DATOS COMPLETOS A ACTUALIZAR
            const dataCompleta = {
                timestamp_lina: new Date().toISOString(),
                estado_ciarp: document.getElementById('edit-estado').value,
                documento_id: document.getElementById('edit-doc-id').value,
                escolaridad: document.getElementById('edit-escolaridad').value,
                categoria_docente: document.getElementById('edit-categoria-docente').value,
                dedicacion: document.getElementById('edit-dedicacion').value,
                facultad: document.getElementById('edit-facultad').value,
                puntaje_eval1: parseFloat(document.getElementById('edit-eval1').value) || 0,
                puntaje_eval2: parseFloat(document.getElementById('edit-eval2').value) || 0,
                puntaje_asignado: parseFloat(document.getElementById('edit-puntaje').value) || 0,
                acta_ciarp: document.getElementById('edit-acta').value,
                resolucion: document.getElementById('edit-resolucion').value,
                observaciones_lina: document.getElementById('edit-observaciones').value,
                
                // ‚úÖ INCLUIR DATOS ORIGINALES PARA SHEETS
                categoria: datosOriginales.categoria,
                titulo_producto: datosOriginales.titulo_producto,
                autor: datosOriginales.autor,
                anio: datosOriginales.anio,
                semestre: datosOriginales.semestre,
                fecha_recibido: datosOriginales.fecha_recibido,
                programa: datosOriginales.programa,
                doc_completa: datosOriginales.doc_completa,
                observaciones_jose: datosOriginales.observaciones_jose,
                
                // ‚úÖ INCLUIR N√öMERO DE FILA Y CATEGOR√çA
                _fila: datosOriginales._fila,
                _categoria: datosOriginales._categoria,
                
                tipo_registro: "LINA"
            };

            // Campos espec√≠ficos por categor√≠a
            if (datosOriginales.categoria === "Art√≠culos Indexados") {
                dataCompleta.issn = document.getElementById('edit-issn')?.value || '';
                dataCompleta.clasificacion_publindex = document.getElementById('edit-clasificacion')?.value || '';
                dataCompleta.editorial = document.getElementById('edit-editorial')?.value || '';
                dataCompleta.anio_publicacion = document.getElementById('edit-anio-pub')?.value || '';
                dataCompleta.num_autores = parseInt(document.getElementById('edit-num-autores')?.value) || 0;
                dataCompleta.universidades_coautores = document.getElementById('edit-universidades')?.value || '';
            } else if (datosOriginales.categoria === "Art√≠culos No Indexados") {
                dataCompleta.issn = document.getElementById('edit-issn')?.value || '';
            } else if (datosOriginales.categoria?.includes("Libro")) {
                dataCompleta.isbn = document.getElementById('edit-isbn')?.value || '';
                dataCompleta.anio_publicacion = document.getElementById('edit-anio-pub')?.value || '';
                dataCompleta.editorial = document.getElementById('edit-editorial')?.value || '';
            }

            console.log("üì§ Enviando actualizaci√≥n completa a Sheets:", dataCompleta);

            // 1. ACTUALIZAR FIREBASE
            await updateDoc(docRef, dataCompleta);
            console.log("‚úÖ Firebase actualizado");

            // 2. ACTUALIZAR GOOGLE SHEETS
            const response = await fetch(urlAppsScript, {
                method: 'POST',
                mode: 'no-cors', // Importante para evitar CORS
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataCompleta)
            });

            console.log("‚úÖ Solicitud enviada a Sheets");

            alert("‚úÖ Evaluaci√≥n guardada y sincronizada correctamente");
            cerrarModal();
            cargarPendientesLina();

        } catch (error) {
            console.error("‚ùå Error:", error);
            alert("‚ùå Error al guardar: " + error.message);
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<span>üíæ</span> GUARDAR COMPILADO COMPLETO';
        }
    };
    
    // ==================== SINCRONIZACI√ìN AUTOM√ÅTICA DESDE SHEETS (LINA) ====================
    
    async function sincronizarDesdeSheets() {
        if (rolActual !== 'LINA') return;
        
        try {
            const categorias = ["Art√≠culos Indexados", "Art√≠culos No Indexados", "Libros", "Cap√≠tulos"];
            let totalActualizados = 0;
            
            for (const categoria of categorias) {
                const registrosSheets = await cargarRegistrosDesdeSheets(categoria);
                
                for (const regSheet of registrosSheets) {
                    const titulo = regSheet["T√çTULO"];
                    const autor = regSheet["AUTOR/DOCENTE"];
                    
                    if (!titulo || !autor) continue;
                    
                    // Buscar en Firebase por t√≠tulo + autor
                    const q = query(
                        collection(db, "solicitudes"),
                        where("titulo_producto", "==", titulo),
                        where("autor", "==", autor),
                        limit(1)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const docSnap = querySnapshot.docs[0];
                        const dataFirebase = docSnap.data();
                        
                        // Comparar timestamps
                        const timestampSheets = regSheet["TIMESTAMP LINA"];
                        const timestampFirebase = dataFirebase.timestamp_lina;
                        
                        // Si Sheets tiene cambios m√°s recientes
                        if (timestampSheets && timestampSheets !== timestampFirebase) {
                            const actualizacion = {
                                puntaje_eval1: parseFloat(regSheet["EVAL 1"]) || 0,
                                puntaje_eval2: parseFloat(regSheet["EVAL 2"]) || 0,
                                puntaje_asignado: parseFloat(regSheet["PUNTAJE FINAL"]) || 0,
                                estado_ciarp: regSheet["ESTADO FINAL"] || dataFirebase.estado_ciarp,
                                documento_id: regSheet["DOC ID"] || dataFirebase.documento_id,
                                escolaridad: regSheet["ESCOLARIDAD"] || dataFirebase.escolaridad,
                                categoria_docente: regSheet["CATEGOR√çA DOCENTE"] || dataFirebase.categoria_docente,
                                dedicacion: regSheet["DEDICACI√ìN"] || dataFirebase.dedicacion,
                                facultad: regSheet["FACULTAD"] || dataFirebase.facultad,
                                acta_ciarp: regSheet["ACTA CIARP"] || dataFirebase.acta_ciarp,
                                resolucion: regSheet["RESOLUCI√ìN"] || dataFirebase.resolucion,
                                observaciones_lina: regSheet["OBS LINA"] || dataFirebase.observaciones_lina,
                                timestamp_lina: timestampSheets,
                                _fila: regSheet["_fila"] || dataFirebase._fila
                            };
                            
                            await updateDoc(doc(db, "solicitudes", docSnap.id), actualizacion);
                            totalActualizados++;
                            console.log(`üîÑ Sincronizado desde Sheets: ${titulo}`);
                        }
                    }
                }
            }
            
            if (totalActualizados > 0) {
                console.log(`‚úÖ ${totalActualizados} registros sincronizados desde Sheets`);
                // Recargar la tabla de pendientes si hay actualizaciones
                cargarPendientesLina();
            }
            
        } catch (error) {
            console.error("‚ö†Ô∏è Error en sincronizaci√≥n autom√°tica:", error);
        }
    }
    
    // Iniciar sincronizaci√≥n autom√°tica para Lina (cada 20 segundos)
    function iniciarSincronizacionAutomatica() {
        if (intervalSincronizacionLina) {
            clearInterval(intervalSincronizacionLina);
        }
        
        // Sincronizar cada 20 segundos
        intervalSincronizacionLina = setInterval(sincronizarDesdeSheets, 20000);
        
        // Primera sincronizaci√≥n inmediata
        sincronizarDesdeSheets();
        
        console.log("‚úÖ Sincronizaci√≥n autom√°tica activada (cada 20s)");
    }
    
    // ==================== MODIFICAR FUNCI√ìN DE INICIO DE SESI√ìN ====================
    
    const iniciarSesionOriginal = window.iniciarSesion;
    window.iniciarSesion = function(rol) {
        iniciarSesionOriginal(rol);
        
        if (rol === 'LINA') {
            iniciarSincronizacionAutomatica();
            cargarPendientesLina();
        } else if (rol === 'JOSE') {
            // Cargar tabla al cambiar categor√≠a
            setTimeout(() => {
                const selectCategoria = document.getElementById('categoria');
                if (selectCategoria) {
                    selectCategoria.addEventListener('change', cargarTablaJose);
                    // Cargar tabla si ya hay una categor√≠a seleccionada
                    if (selectCategoria.value) {
                        cargarTablaJose();
                    }
                }
            }, 500);
        }
    };
    
    // Limpiar intervalos al cerrar sesi√≥n
    window.addEventListener('beforeunload', () => {
        if (intervalSincronizacionLina) {
            clearInterval(intervalSincronizacionLina);
        }
    });

</script>

<!-- ==================== HTML: TABLA DE REGISTROS PARA JOS√â ==================== -->

<!-- Agregar esta secci√≥n en el panel de Jos√©, despu√©s del formulario -->

<div class="mt-8 bg-white rounded-xl shadow-lg p-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <span class="bg-[#003d2b] text-white p-2 rounded">üìä</span>
            REGISTROS INGRESADOS
        </h3>
        <button onclick="cargarTablaJose()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all hover:scale-105">
            üîÑ ACTUALIZAR
        </button>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full border-collapse border">
            <thead>
                <tr class="bg-[#003d2b] text-white">
                    <th class="border px-3 py-2 text-xs font-bold">A√ëO</th>
                    <th class="border px-3 py-2 text-xs font-bold">SEM</th>
                    <th class="border px-3 py-2 text-xs font-bold">T√çTULO</th>
                    <th class="border px-3 py-2 text-xs font-bold">AUTOR</th>
                    <th class="border px-3 py-2 text-xs font-bold">FECHA</th>
                    <th class="border px-3 py-2 text-xs font-bold">ESTADO</th>
                    <th class="border px-3 py-2 text-xs font-bold">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tabla-registros-jose">
                <tr>
                    <td colspan="7" class="text-center py-4 text-gray-500">
                        Seleccione una categor√≠a para ver los registros
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== ESTILOS ADICIONALES ==================== -->
<style>
    /* Animaci√≥n para el bot√≥n de actualizar */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    button:active {
        transform: scale(0.98);
    }
    
    /* Hover effect para filas de tabla */
    tbody tr:hover {
        background-color: #f9fafb;
        transition: background-color 0.2s;
    }
</style>

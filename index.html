<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n CIARP - Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- ==================== CONTENEDOR PRINCIPAL ==================== -->
<div id="app" class="container mx-auto px-4 py-8">
    
    <!-- PANTALLA DE INICIO DE SESI√ìN -->
    <div id="pantalla-login" class="max-w-md mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
            <h1 class="text-3xl font-bold text-[#003d2b] mb-6">SISTEMA CIARP</h1>
            <div class="space-y-4">
                <button onclick="iniciarSesion('JOSE')" 
                        class="w-full bg-[#003d2b] hover:bg-[#002d1f] text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105">
                    üë®‚Äçüíº INGRESAR COMO JOS√â
                </button>
                <button onclick="iniciarSesion('LINA')" 
                        class="w-full bg-[#1e3a8a] hover:bg-[#1e40af] text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105">
                    üë©‚Äçüíº INGRESAR COMO LINA
                </button>
            </div>
        </div>
    </div>

    <!-- PANEL JOS√â -->
    <div id="panel-jose" class="hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-[#003d2b]">PANEL DE JOS√â - INGRESO DE DATOS</h2>
                <button onclick="cerrarSesion()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>

            <!-- FORMULARIO JOS√â -->
            <form id="form-jose" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Categor√≠a *</label>
                        <select id="categoria" required class="w-full border rounded-lg px-3 py-2">
                            <option value="">Seleccione...</option>
                            <option value="Art√≠culos Indexados">Art√≠culos Indexados</option>
                            <option value="Art√≠culos No Indexados">Art√≠culos No Indexados</option>
                            <option value="Libros">Libros</option>
                            <option value="Cap√≠tulos">Cap√≠tulos de Libro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">A√±o *</label>
                        <input type="number" id="anio" required class="w-full border rounded-lg px-3 py-2" min="2020" max="2030">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Semestre *</label>
                        <select id="semestre" required class="w-full border rounded-lg px-3 py-2">
                            <option value="">Seleccione...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Fecha Recibido *</label>
                        <input type="date" id="fecha-recibido" required class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">T√≠tulo del Producto *</label>
                        <input type="text" id="nombre_articulo" class="w-full border rounded-lg px-3 py-2" placeholder="Ingrese el t√≠tulo">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Autor/Docente *</label>
                        <input type="text" id="autor" required class="w-full border rounded-lg px-3 py-2" list="lista-docentes">
                        <datalist id="lista-docentes"></datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Programa</label>
                        <input type="text" id="programa" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Documentaci√≥n Completa</label>
                        <select id="doc-completa" class="w-full border rounded-lg px-3 py-2">
                            <option value="S√≠">S√≠</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Estado Inicial</label>
                        <select id="estado-ciarp" class="w-full border rounded-lg px-3 py-2">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="No Aprobado">No Aprobado</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2">Observaciones</label>
                        <textarea id="observaciones-jose" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                    </div>
                </div>

                <button type="button" id="btn-enviar-jose" onclick="enviarSolicitud()"
                        class="w-full bg-[#003d2b] hover:bg-[#002d1f] text-white font-bold py-3 rounded-lg transition-all">
                    üì§ ENVIAR SOLICITUD
                </button>
            </form>
        </div>

        <!-- TABLA DE REGISTROS JOS√â -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-[#003d2b] text-white p-2 rounded">üìä</span>
                    REGISTROS INGRESADOS
                </h3>
                <button onclick="cargarTablaJose()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all hover:scale-105">
                    üîÑ ACTUALIZAR
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border">
                    <thead>
                        <tr class="bg-[#003d2b] text-white">
                            <th class="border px-3 py-2 text-xs font-bold">A√ëO</th>
                            <th class="border px-3 py-2 text-xs font-bold">SEM</th>
                            <th class="border px-3 py-2 text-xs font-bold">T√çTULO</th>
                            <th class="border px-3 py-2 text-xs font-bold">AUTOR</th>
                            <th class="border px-3 py-2 text-xs font-bold">FECHA</th>
                            <th class="border px-3 py-2 text-xs font-bold">ESTADO</th>
                            <th class="border px-3 py-2 text-xs font-bold">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-registros-jose">
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">
                                Seleccione una categor√≠a para ver los registros
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PANEL LINA -->
    <div id="panel-lina" class="hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-[#1e3a8a]">PANEL DE LINA - EVALUACI√ìN</h2>
                <button onclick="cerrarSesion()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>

            <!-- TABLA DE PENDIENTES -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border">
                    <thead>
                        <tr class="bg-[#1e3a8a] text-white">
                            <th class="border px-3 py-2 text-xs">CATEGOR√çA</th>
                            <th class="border px-3 py-2 text-xs">T√çTULO</th>
                            <th class="border px-3 py-2 text-xs">AUTOR</th>
                            <th class="border px-3 py-2 text-xs">FECHA</th>
                            <th class="border px-3 py-2 text-xs">ESTADO</th>
                            <th class="border px-3 py-2 text-xs">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pendientes-lina"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE EVALUACI√ìN LINA -->
<div id="modal-evaluacion" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4">
        <h3 class="text-2xl font-bold text-[#1e3a8a] mb-6">EVALUACI√ìN COMPLETA</h3>
        
        <input type="hidden" id="modal-id">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold mb-2">Estado Final</label>
                <select id="edit-estado" class="w-full border rounded-lg px-3 py-2">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Aprobado">Aprobado</option>
                    <option value="No Aprobado">No Aprobado</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Documento ID</label>
                <input type="text" id="edit-doc-id" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Escolaridad</label>
                <input type="text" id="edit-escolaridad" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Categor√≠a Docente</label>
                <input type="text" id="edit-categoria-docente" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Dedicaci√≥n</label>
                <input type="text" id="edit-dedicacion" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Facultad</label>
                <input type="text" id="edit-facultad" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Evaluaci√≥n 1</label>
                <input type="number" id="edit-eval1" step="0.01" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Evaluaci√≥n 2</label>
                <input type="number" id="edit-eval2" step="0.01" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Puntaje Final</label>
                <input type="number" id="edit-puntaje" step="0.01" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Acta CIARP</label>
                <input type="text" id="edit-acta" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Resoluci√≥n</label>
                <input type="text" id="edit-resolucion" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">ISSN</label>
                <input type="text" id="edit-issn" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">ISBN</label>
                <input type="text" id="edit-isbn" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Editorial</label>
                <input type="text" id="edit-editorial" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">A√±o Publicaci√≥n</label>
                <input type="text" id="edit-anio-pub" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">Clasificaci√≥n Publindex</label>
                <input type="text" id="edit-clasificacion" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">N√∫m. Autores</label>
                <input type="number" id="edit-num-autores" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-bold mb-2">Universidades Coautores</label>
                <input type="text" id="edit-universidades" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-bold mb-2">Observaciones</label>
                <textarea id="edit-observaciones" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
            </div>
        </div>

        <div class="flex gap-4 mt-6">
            <button id="btn-guardar-lina" onclick="guardarEvaluacion()"
                    class="flex-1 bg-[#1e3a8a] hover:bg-[#1e40af] text-white font-bold py-3 rounded-lg transition-all">
                <span>üíæ</span> GUARDAR COMPILADO COMPLETO
            </button>
            <button onclick="cerrarModal()"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all">
                ‚ùå CANCELAR
            </button>
        </div>
    </div>
</div>

<!-- ==================== FIREBASE Y JAVASCRIPT ==================== -->
<script type="module">
    // IMPORTAR FIREBASE
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, updateDoc, getDoc, deleteDoc, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // CONFIGURACI√ìN FIREBASE
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_AUTH_DOMAIN",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_STORAGE_BUCKET",
        messagingSenderId: "TU_MESSAGING_SENDER_ID",
        appId: "TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // URL DE APPS SCRIPT
    const urlAppsScript = "https://script.google.com/macros/s/AKfycbzmqI6kYjm6fKE__pspHGSZ4bMQS5nCtpb2mZqisq5z32Hrdw5vfTfZYyrGSfHJU2PcHA/exec";

    // VARIABLES GLOBALES
    let rolActual = null;
    let registrosJose = [];
    let intervalActualizacion = null;
    let intervalSincronizacionLina = null;

    // ==================== FUNCIONES DE SESI√ìN ====================

    window.iniciarSesion = function(rol) {
        rolActual = rol;
        document.getElementById('pantalla-login').classList.add('hidden');
        
        if (rol === 'JOSE') {
            document.getElementById('panel-jose').classList.remove('hidden');
            cargarDocentes();
            
            // Cargar tabla al cambiar categor√≠a
            setTimeout(() => {
                const selectCategoria = document.getElementById('categoria');
                if (selectCategoria) {
                    selectCategoria.addEventListener('change', cargarTablaJose);
                    if (selectCategoria.value) {
                        cargarTablaJose();
                    }
                }
            }, 500);
        } else if (rol === 'LINA') {
            document.getElementById('panel-lina').classList.remove('hidden');
            iniciarSincronizacionAutomatica();
            cargarPendientesLina();
        }
    };

    window.cerrarSesion = function() {
        rolActual = null;
        if (intervalSincronizacionLina) {
            clearInterval(intervalSincronizacionLina);
        }
        document.getElementById('panel-jose').classList.add('hidden');
        document.getElementById('panel-lina').classList.add('hidden');
        document.getElementById('pantalla-login').classList.remove('hidden');
    };

    // ==================== CARGAR DOCENTES ====================

    async function cargarDocentes() {
        try {
            const response = await fetch(`${urlAppsScript}?action=obtenerDocentes`);
            const docentes = await response.json();
            
            const datalist = document.getElementById('lista-docentes');
            datalist.innerHTML = '';
            
            docentes.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.nombre;
                datalist.appendChild(option);
            });
            
            console.log('‚úÖ Docentes cargados:', docentes.length);
        } catch (error) {
            console.error('‚ùå Error al cargar docentes:', error);
        }
    }

    // ==================== SINCRONIZACI√ìN BIDIRECCIONAL ====================

    async function guardarFilaEnFirebase(firebaseId, fila, categoria) {
        try {
            const docRef = doc(db, "solicitudes", firebaseId);
            await updateDoc(docRef, {
                _fila: fila,
                _categoria: categoria,
                _ultimaActualizacion: new Date().toISOString()
            });
            console.log("‚úÖ Fila guardada en Firebase:", fila);
        } catch (error) {
            console.error("‚ùå Error al guardar fila:", error);
        }
    }

    async function cargarRegistrosDesdeSheets(categoria) {
        try {
            const response = await fetch(
                `${urlAppsScript}?action=obtenerRegistros&categoria=${encodeURIComponent(categoria)}`
            );
            const data = await response.json();
            
            if (data && Array.isArray(data)) {
                console.log(`‚úÖ Registros cargados desde Sheets (${categoria}):`, data.length);
                return data;
            }
            return [];
        } catch (error) {
            console.error("‚ùå Error al cargar desde Sheets:", error);
            return [];
        }
    }

    // ==================== TABLA DE REGISTROS JOS√â ====================

    window.cargarTablaJose = async () => {
        const categoria = document.getElementById('categoria').value;
        if (!categoria) {
            document.getElementById('tabla-registros-jose').innerHTML = 
                '<tr><td colspan="7" class="text-center py-4 text-gray-500">Seleccione una categor√≠a primero</td></tr>';
            return;
        }
        
        try {
            const q = query(
                collection(db, "solicitudes"),
                where("categoria", "==", categoria),
                orderBy("timestamp", "desc")
            );
            const querySnapshot = await getDocs(q);
            
            const tbody = document.getElementById('tabla-registros-jose');
            tbody.innerHTML = '';
            
            if (querySnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay registros en esta categor√≠a</td></tr>';
                return;
            }
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const estadoColor = data.estado_ciarp === 'Aprobado' ? 'bg-green-100 text-green-800' : 
                                   data.estado_ciarp === 'No Aprobado' ? 'bg-red-100 text-red-800' : 
                                   'bg-yellow-100 text-yellow-800';
                
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="border px-2 py-2 text-xs">${data.anio || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.semestre || ''}</td>
                        <td class="border px-2 py-2 text-xs font-semibold">${data.titulo_producto || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.autor || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.fecha_recibido || ''}</td>
                        <td class="border px-2 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold ${estadoColor}">
                                ${data.estado_ciarp || 'Pendiente'}
                            </span>
                        </td>
                        <td class="border px-2 py-2 text-center">
                            <button onclick="eliminarRegistroJose('${docSnap.id}', '${data._categoria}', ${data._fila})" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-bold">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
        } catch (error) {
            console.error("‚ùå Error al cargar tabla:", error);
            document.getElementById('tabla-registros-jose').innerHTML = 
                '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar registros</td></tr>';
        }
    };

    // ==================== ELIMINAR REGISTRO ====================

    window.eliminarRegistroJose = async (firebaseId, categoria, fila) => {
        if (!confirm('¬øEst√° seguro de eliminar este registro? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        try {
            const response = await fetch(
                `${urlAppsScript}?action=eliminarRegistro&categoria=${encodeURIComponent(categoria)}&fila=${fila}`,
                { method: 'GET' }
            );
            
            const result = await response.json();
            
            if (result.status === 'success') {
                const docRef = doc(db, "solicitudes", firebaseId);
                await deleteDoc(docRef);
                
                alert(`‚úÖ Registro eliminado: ${result.titulo}`);
                cargarTablaJose();
            } else {
                throw new Error(result.message || 'Error al eliminar de Sheets');
            }
            
        } catch (error) {
            console.error("‚ùå Error al eliminar:", error);
            alert("‚ùå Error al eliminar: " + error.message);
        }
    };

    // ==================== ENVIAR SOLICITUD JOS√â ====================

    window.enviarSolicitud = async () => {
        const categoria = document.getElementById('categoria').value;
        const anio = document.getElementById('anio').value;
        const semestre = document.getElementById('semestre').value;
        const fechaRecibido = document.getElementById('fecha-recibido').value;
        const autor = document.getElementById('autor').value;
        const programa = document.getElementById('programa').value;
        const docCompleta = document.getElementById('doc-completa').value;
        const estadoCiarp = document.getElementById('estado-ciarp').value;
        const observaciones = document.getElementById('observaciones-jose').value;

        if (!categoria || !anio || !semestre || !fechaRecibido || !autor) {
            alert("‚ö†Ô∏è Complete los campos obligatorios");
            return;
        }

        let tituloProducto = document.getElementById('nombre_articulo')?.value || '';

        if (!tituloProducto) {
            alert("‚ö†Ô∏è Complete el t√≠tulo del producto");
            return;
        }

        const btnEnviar = document.getElementById('btn-enviar-jose');
        btnEnviar.disabled = true;
        btnEnviar.innerText = "‚è≥ ENVIANDO...";

        try {
            const datosFirebase = {
                categoria: categoria,
                anio: anio,
                semestre: semestre,
                fecha_recibido: fechaRecibido,
                titulo_producto: tituloProducto,
                autor: autor,
                programa: programa,
                doc_completa: docCompleta,
                estado_ciarp: estadoCiarp,
                observaciones_jose: observaciones,
                timestamp: new Date().toISOString(),
                tipo_registro: "JOSE"
            };

            const docRef = await addDoc(collection(db, "solicitudes"), datosFirebase);
            console.log("‚úÖ Registro creado en Firebase:", docRef.id);

            const datosSheets = {
                ...datosFirebase,
                tipo_registro: "JOSE"
            };

            const response = await fetch(urlAppsScript, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosSheets)
            });

            const result = await response.json();
            
            if (result.status === 'success' && result.fila) {
                await guardarFilaEnFirebase(docRef.id, result.fila, categoria);
                
                alert("‚úÖ Registro creado y sincronizado correctamente");
                document.getElementById('form-jose').reset();
                cargarTablaJose();
            } else {
                throw new Error("Error al crear en Sheets");
            }

        } catch (error) {
            console.error("‚ùå Error:", error);
            alert("‚ùå Error al guardar: " + error.message);
        } finally {
            btnEnviar.disabled = false;
            btnEnviar.innerText = "üì§ ENVIAR SOLICITUD";
        }
    };

    // ==================== CARGAR PENDIENTES LINA ====================

    window.cargarPendientesLina = async () => {
        try {
            const q = query(collection(db, "solicitudes"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            
            const tbody = document.getElementById('tabla-pendientes-lina');
            tbody.innerHTML = '';
            
            if (querySnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay registros pendientes</td></tr>';
                return;
            }
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const estadoColor = data.estado_ciarp === 'Aprobado' ? 'bg-green-100 text-green-800' : 
                                   data.estado_ciarp === 'No Aprobado' ? 'bg-red-100 text-red-800' : 
                                   'bg-yellow-100 text-yellow-800';
                
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="border px-2 py-2 text-xs">${data.categoria || ''}</td>
                        <td class="border px-2 py-2 text-xs font-semibold">${data.titulo_producto || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.autor || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.fecha_recibido || ''}</td>
                        <td class="border px-2 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold ${estadoColor}">
                                ${data.estado_ciarp || 'Pendiente'}
                            </span>
                        </td>
                        <td class="border px-2 py-2 text-center">
                            <button onclick="abrirModalEvaluacion('${docSnap.id}')" 
                                    class="bg-[#1e3a8a] hover:bg-[#1e40af] text-white px-3 py-1 rounded text-xs font-bold">
                                ‚úèÔ∏è Evaluar
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
        } catch (error) {
            console.error("‚ùå Error al cargar pendientes:", error);
        }
    };

    // ==================== MODAL EVALUACI√ìN ====================

    window.abrirModalEvaluacion = async (id) => {
        try {
            const docRef = doc(db, "solicitudes", id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                document.getElementById('modal-id').value = id;
                document.getElementById('edit-estado').value = data.estado_ciarp || 'Pendiente';
                document.getElementById('edit-doc-id').value = data.documento_id || '';
                document.getElementById('edit-escolaridad').value = data.escolaridad || '';
                document.getElementById('edit-categoria-docente').value = data.categoria_docente || '';
                document.getElementById('edit-dedicacion').value = data.dedicacion || '';
                document.getElementById('edit-facultad').value = data.facultad || '';
                document.getElementById('edit-eval1').value = data.puntaje_eval1 || 0;
                document.getElementById('edit-eval2').value = data.puntaje_eval2 || 0;
                document.getElementById('edit-puntaje').value = data.puntaje_asignado || 0;
                document.getElementById('edit-acta').value = data.acta_ciarp || '';
                document.getElementById('edit-resolucion').value = data.resolucion || '';
                document.getElementById('edit-issn').value = data.issn || '';
                document.getElementById('edit-isbn').value = data.isbn || '';
                document.getElementById('edit-editorial').value = data.editorial || '';
                document.getElementById('edit-anio-pub').value = data.anio_publicacion || '';
                document.getElementById('edit-clasificacion').value = data.clasificacion_publindex || '';
                document.getElementById('edit-num-autores').value = data.num_autores || 0;
                document.getElementById('edit-universidades').value = data.universidades_coautores || '';
                document.getElementById('edit-observaciones').value = data.observaciones_lina || '';
                
                document.getElementById('modal-evaluacion').classList.remove('hidden');
            }
        } catch (error) {
            console.error("‚ùå Error:", error);
            alert("‚ùå Error al cargar datos");
        }
    };

    window.cerrarModal = function() {
        document.getElementById('modal-evaluacion').classList.add('hidden');
    };

    // ==================== GUARDAR EVALUACI√ìN ====================

    window.guardarEvaluacion = async () => {
        const idActual = document.getElementById('modal-id').value;
        
        if (!idActual) {
            alert("‚ö†Ô∏è No se encontr√≥ el ID del documento");
            return;
        }

        const btnGuardar = document.getElementById('btn-guardar-lina');
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="animate-pulse">‚è≥</span> GUARDANDO...';

        try {
            const docRef = doc(db, "solicitudes", idActual);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                throw new Error("Documento no encontrado");
            }

            const datosOriginales = docSnap.data();

            const dataCompleta = {
                timestamp_lina: new Date().toISOString(),
                estado_ciarp: document.getElementById('edit-estado').value,
                documento_id: document.getElementById('edit-doc-id').value,
                escolaridad: document.getElementById('edit-escolaridad').value,
                categoria_docente: document.getElementById('edit-categoria-docente').value,
                dedicacion: document.getElementById('edit-dedicacion').value,
                facultad: document.getElementById('edit-facultad').value,
                puntaje_eval1: parseFloat(document.getElementById('edit-eval1').value) || 0,
                puntaje_eval2: parseFloat(document.getElementById('edit-eval2').value) || 0,
                puntaje_asignado: parseFloat(document.getElementById('edit-puntaje').value) || 0,
                acta_ciarp: document.getElementById('edit-acta').value,
                resolucion: document.getElementById('edit-resolucion').value,
                observaciones_lina: document.getElementById('edit-observaciones').value,
                
                categoria: datosOriginales.categoria,
                titulo_producto: datosOriginales.titulo_producto,
                autor: datosOriginales.autor,
                anio: datosOriginales.anio,
                semestre: datosOriginales.semestre,
                fecha_recibido: datosOriginales.fecha_recibido,
                programa: datosOriginales.programa,
                doc_completa: datosOriginales.doc_completa,
                observaciones_jose: datosOriginales.observaciones_jose,
                
                _fila: datosOriginales._fila,
                _categoria: datosOriginales._categoria,
                
                tipo_registro: "LINA"
            };

            if (datosOriginales.categoria === "Art√≠culos Indexados") {
                dataCompleta.issn = document.getElementById('edit-issn')?.value || '';
                dataCompleta.clasificacion_publindex = document.getElementById('edit-clasificacion')?.value || '';
                dataCompleta.editorial = document.getElementById('edit-editorial')?.value || '';
                dataCompleta.anio_publicacion = document.getElementById('edit-anio-pub')?.value || '';
                dataCompleta.num_autores = parseInt(document.getElementById('edit-num-autores')?.value) || 0;
                dataCompleta.universidades_coautores = document.getElementById('edit-universidades')?.value || '';
            } else if (datosOriginales.categoria === "Art√≠culos No Indexados") {
                dataCompleta.issn = document.getElementById('edit-issn')?.value || '';
            } else if (datosOriginales.categoria?.includes("Libro")) {
                dataCompleta.isbn = document.getElementById('edit-isbn')?.value || '';
                dataCompleta.anio_publicacion = document.getElementById('edit-anio-pub')?.value || '';
                dataCompleta.editorial = document.getElementById('edit-editorial')?.value || '';
            }

            console.log("üì§ Enviando actualizaci√≥n completa a Sheets:", dataCompleta);

            await updateDoc(docRef, dataCompleta);
            console.log("‚úÖ Firebase actualizado");

            const response = await fetch(urlAppsScript, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataCompleta)
            });

            console.log("‚úÖ Solicitud enviada a Sheets");

            alert("‚úÖ Evaluaci√≥n guardada y sincronizada correctamente");
            cerrarModal();
            cargarPendientesLina();

        } catch (error) {
            console.error("‚ùå Error:", error);
            alert("‚ùå Error al guardar: " + error.message);
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<span>üíæ</span> GUARDAR COMPILADO COMPLETO';
        }
    };

    // ==================== SINCRONIZACI√ìN AUTOM√ÅTICA ====================

    async function sincronizarDesdeSheets() {
        if (rolActual !== 'LINA') return;
        
        try {
            const categorias = ["Art√≠culos Indexados", "Art√≠culos No Indexados", "Libros", "Cap√≠tulos"];
            let totalActualizados = 0;
            
            for (const categoria of categorias) {
                const registrosSheets = await cargarRegistrosDesdeSheets(categoria);
                
                for (const regSheet of registrosSheets) {
                    const titulo = regSheet["T√çTULO"];
                    const autor = regSheet["AUTOR/DOCENTE"];
                    
                    if (!titulo || !autor) continue;
                    
                    const q = query(
                        collection(db, "solicitudes"),
                        where("titulo_producto", "==", titulo),
                        where("autor", "==", autor),
                        limit(1)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const docSnap = querySnapshot.docs[0];
                        const dataFirebase = docSnap.data();
                        
                        const timestampSheets = regSheet["TIMESTAMP LINA"];
                        const timestampFirebase = dataFirebase.timestamp_lina;
                        
                        if (timestampSheets && timestampSheets !== timestampFirebase) {
                            const actualizacion = {
                                puntaje_eval1: parseFloat(regSheet["EVAL 1"]) || 0,
                                puntaje_eval2: parseFloat(regSheet["EVAL 2"]) || 0,
                                puntaje_asignado: parseFloat(regSheet["PUNTAJE FINAL"]) || 0,
                                estado_ciarp: regSheet["ESTADO FINAL"] || dataFirebase.estado_ciarp,
                                documento_id: regSheet["DOC ID"] || dataFirebase.documento_id,
                                escolaridad: regSheet["ESCOLARIDAD"] || dataFirebase.escolaridad,
                                categoria_docente: regSheet["CATEGOR√çA DOCENTE"] || dataFirebase.categoria_docente,
                                dedicacion: regSheet["DEDICACI√ìN"] || dataFirebase.dedicacion,
                                facultad: regSheet["FACULTAD"] || dataFirebase.facultad,
                                acta_ciarp: regSheet["ACTA CIARP"] || dataFirebase.acta_ciarp,
                                resolucion: regSheet["RESOLUCI√ìN"] || dataFirebase.resolucion,
                                observaciones_lina: regSheet["OBS LINA"] || dataFirebase.observaciones_lina,
                                timestamp_lina: timestampSheets,
                                _fila: regSheet["_fila"] || dataFirebase._fila
                            };
                            
                            await updateDoc(doc(db, "solicitudes", docSnap.id), actualizacion);
                            totalActualizados++;
                            console.log(`üîÑ Sincronizado desde Sheets: ${titulo}`);
                        }
                    }
                }
            }
            
            if (totalActualizados > 0) {
                console.log(`‚úÖ ${totalActualizados} registros sincronizados desde Sheets`);
                cargarPendientesLina();
            }
            
        } catch (error) {
            console.error("‚ö†Ô∏è Error en sincronizaci√≥n autom√°tica:", error);
        }
    }

    function iniciarSincronizacionAutomatica() {
        if (intervalSincronizacionLina) {
            clearInterval(intervalSincronizacionLina);
        }
        
        intervalSincronizacionLina = setInterval(sincronizarDesdeSheets, 20000);
        sincronizarDesdeSheets();
        
        console.log("‚úÖ Sincronizaci√≥n autom√°tica activada (cada 20s)");
    }

    window.addEventListener('beforeunload', () => {
        if (intervalSincronizacionLina) {
            clearInterval(intervalSincronizacionLina);
        }
    });
</script>

<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    button:active {
        transform: scale(0.98);
    }
    
    tbody tr:hover {
        background-color: #f9fafb;
        transition: background-color 0.2s;
    }
</style>

</body>
</html>

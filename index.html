<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Productividad UQ 2024 - MEJORADO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbqMf8ZOmqmbGTmr2tr8nziyUWKSE6OWg",
            authDomain: "uniquindio-produccion.firebaseapp.com",
            projectId: "uniquindio-produccion",
            storageBucket: "uniquindio-produccion.firebasestorage.app",
            messagingSenderId: "440871309124",
            appId: "1:440871309124:web:108be1894adaf6ecaf1111"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // URL DE TU APPS SCRIPT
        const urlAppsScript = "https://script.google.com/macros/s/AKfycbxz0ZR9wQeCzX8Z5dHSQbV0QPYBvsJ2akQMf2pMQYxU2lYU5-klM3D9bsEy9YN15ON7VQ/exec";

        let rolActual = '';
        let idRegistroActual = null;

        const CONTRASE√ëAS = {
            'JOSE': 'jose2026',
            'LINA': 'lina2026'
        };

        // ==================== LOGIN ====================
        window.intentarLogin = (rol) => {
            const password = document.getElementById(`password-${rol.toLowerCase()}`).value;
            
            if (!password) {
                alert("‚ö†Ô∏è Ingrese la contrase√±a");
                return;
            }
            
            if (password === CONTRASE√ëAS[rol]) {
                iniciarSesion(rol);
            } else {
                alert("‚ùå Contrase√±a incorrecta");
                document.getElementById(`password-${rol.toLowerCase()}`).value = '';
            }
        };

        function iniciarSesion(rol) {
            rolActual = rol;
            document.getElementById('pantalla-login').classList.add('hidden');
            
            if (rol === 'JOSE') {
                document.getElementById('panel-jose').classList.remove('hidden');
                document.getElementById('header-title').innerText = "SEGUIMIENTO DE SOLICITUDES (JOS√â)";
                document.getElementById('header-bg').classList.add('bg-[#003d2b]');
                cambiarCategoria(); // Inicializar campos
            } else {
                document.getElementById('panel-lina').classList.remove('hidden');
                document.getElementById('header-title').innerText = "COMPILADO Y LIQUIDACI√ìN (LINA)";
                document.getElementById('header-bg').classList.add('bg-blue-900');
                cargarPendientesLina();
            }
        }

        // ==================== JOS√â - SOLO SEGUIMIENTO ====================
        window.cambiarCategoria = () => {
            const cat = document.getElementById('categoria').value;
            const container = document.getElementById('campos-jose-especificos');
            const inputClass = "w-full p-2 border border-gray-300 rounded focus:border-green-600 outline-none";
            const labelClass = "block text-xs font-bold text-gray-500 uppercase mb-1";
            let html = '';

            // JOS√â SOLO VE SUS CAMPOS ESPEC√çFICOS
            if (cat === "Art√≠culos Indexados" || cat === "Art√≠culos No Indexados") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Nombre del Art√≠culo</label><input type="text" id="nombre_articulo" class="${inputClass}"></div>
                    <div><label class="${labelClass}">T√≠tulo de la Revista</label><input type="text" id="titulo_revista" class="${inputClass}"></div>
                </div>`;
            
            } else if (cat === "Libro Investigaci√≥n" || cat === "Libro Texto" || cat === "Libro Ensayo") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Profesor Solicitante</label><input type="text" id="profesor_solicitante" class="${inputClass}"></div>
                    <div><label class="${labelClass}">√Årea de Conocimiento</label><input type="text" id="area_conocimiento" class="${inputClass}"></div>
                </div>`;
            
            } else if (cat === "Premio") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">T√≠tulo del Trabajo Premiado</label><input type="text" id="titulo_trabajo_premiado" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Premio Otorgado</label><input type="text" id="premio_otorgado" class="${inputClass}"></div>
                    <div class="col-span-2"><label class="${labelClass}">Fecha del Premio</label><input type="date" id="fecha_premio" class="${inputClass}"></div>
                </div>`;
            
            } else if (cat === "Software") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">T√≠tulo del Software</label><input type="text" id="titulo_software" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Concepto Comit√© T√©cnico</label>
                        <select id="concepto_comite" class="${inputClass}">
                            <option value="">Pendiente</option>
                            <option value="SI">SI - Aprobado</option>
                            <option value="NO">NO - Rechazado</option>
                        </select>
                    </div>
                </div>`;
            
            } else if (cat === "Patente") {
                html = `<div><label class="${labelClass}">T√≠tulo de la Patente</label><input type="text" id="titulo_patente" class="${inputClass}"></div>`;
            
            } else if (cat === "Obra Art√≠stica" || cat === "Producci√≥n Audiovisual") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">T√≠tulo de la Obra</label><input type="text" id="titulo_obra" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Soportes Verificados</label>
                        <select id="soportes_ok" class="${inputClass}">
                            <option value="">Pendiente</option>
                            <option value="OK">OK - Verificado</option>
                            <option value="INCOMPLETO">Incompleto</option>
                        </select>
                    </div>
                </div>`;
            
            } else if (cat === "Ponencias") {
                html = `<div><label class="${labelClass}">T√≠tulo de la Ponencia</label><input type="text" id="titulo_ponencia" class="${inputClass}"></div>`;
            
            } else if (cat === "Tesis") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">T√≠tulo de la Tesis</label><input type="text" id="titulo_tesis" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Autor (Estudiante)</label><input type="text" id="autor_estudiante" class="${inputClass}"></div>
                </div>`;
            
            } else if (cat === "T√≠tulos") {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">T√≠tulo Obtenido</label><input type="text" id="titulo_obtenido" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Universidad que Otorga</label><input type="text" id="universidad_otorga" class="${inputClass}"></div>
                </div>`;
            
            } else if (cat === "Ascensos") {
                html = `<div class="grid grid-cols-3 gap-4">
                    <div><label class="${labelClass}">Tipo de Trabajo</label>
                        <select id="tipo_trabajo" class="${inputClass}">
                            <option value="">Seleccionar</option>
                            <option>Docencia</option>
                            <option>Investigaci√≥n</option>
                            <option>Extensi√≥n</option>
                        </select>
                    </div>
                    <div><label class="${labelClass}">Categor√≠a Actual</label>
                        <select id="categoria_actual" class="${inputClass}">
                            <option value="">Seleccionar</option>
                            <option>Auxiliar</option>
                            <option>Asistente</option>
                            <option>Asociado</option>
                            <option>Titular</option>
                        </select>
                    </div>
                    <div><label class="${labelClass}">Categor√≠a Solicitada</label>
                        <select id="categoria_solicitada" class="${inputClass}">
                            <option value="">Seleccionar</option>
                            <option>Auxiliar</option>
                            <option>Asistente</option>
                            <option>Asociado</option>
                            <option>Titular</option>
                        </select>
                    </div>
                </div>`;
            
            } else {
                html = `<p class="text-gray-500 text-sm italic">Sin campos adicionales</p>`;
            }
            
            container.innerHTML = html;
        };

        // JOS√â: GUARDAR SOLICITUD (SOLO SUS DATOS)
        document.getElementById('form-jose').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-jose');
            btn.innerText = "GUARDANDO..."; 
            btn.disabled = true;

            const categoria = document.getElementById('categoria').value;
            
            // JOS√â SOLO ENV√çA SUS DATOS
            const registro = {
                // DATOS B√ÅSICOS (JOS√â)
                anio: "2024",
                semestre: document.getElementById('semestre').value,
                categoria: categoria,
                fecha_recibido: document.getElementById('fecha_recibido').value,
                titulo_producto: document.getElementById('titulo_producto').value,
                autor: document.getElementById('autor').value,
                programa: document.getElementById('programa').value,
                doc_completa: document.getElementById('doc_completa').value,
                observaciones_jose: document.getElementById('observaciones_jose').value,
                estado_ciarp: document.getElementById('estado_inicial').value,
                
                // CAMPOS ESPEC√çFICOS (SOLO JOS√â)
                nombre_articulo: document.getElementById('nombre_articulo')?.value || '',
                titulo_revista: document.getElementById('titulo_revista')?.value || '',
                profesor_solicitante: document.getElementById('profesor_solicitante')?.value || '',
                area_conocimiento: document.getElementById('area_conocimiento')?.value || '',
                titulo_trabajo_premiado: document.getElementById('titulo_trabajo_premiado')?.value || '',
                premio_otorgado: document.getElementById('premio_otorgado')?.value || '',
                fecha_premio: document.getElementById('fecha_premio')?.value || '',
                titulo_software: document.getElementById('titulo_software')?.value || '',
                concepto_comite: document.getElementById('concepto_comite')?.value || '',
                titulo_patente: document.getElementById('titulo_patente')?.value || '',
                titulo_obra: document.getElementById('titulo_obra')?.value || '',
                soportes_ok: document.getElementById('soportes_ok')?.value || '',
                titulo_ponencia: document.getElementById('titulo_ponencia')?.value || '',
                titulo_tesis: document.getElementById('titulo_tesis')?.value || '',
                autor_estudiante: document.getElementById('autor_estudiante')?.value || '',
                titulo_obtenido: document.getElementById('titulo_obtenido')?.value || '',
                universidad_otorga: document.getElementById('universidad_otorga')?.value || '',
                tipo_trabajo: document.getElementById('tipo_trabajo')?.value || '',
                categoria_actual: document.getElementById('categoria_actual')?.value || '',
                categoria_solicitada: document.getElementById('categoria_solicitada')?.value || '',
                
                // NOTA: JOS√â NO ENV√çA NING√öN CAMPO DE LINA
            };

            try {
                // Guardar en Firebase
                await addDoc(collection(db, 'registros_2024'), registro);
                console.log('‚úÖ Guardado en Firebase');
                
                // Sincronizar con Google Sheets (SOLO datos Jos√©)
                const response = await fetch(urlAppsScript, {
                    method: 'POST',
                    body: JSON.stringify(registro),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                console.log('‚úÖ Google Sheets:', result);
                
                alert("‚úÖ Solicitud registrada en SEGUIMIENTO");
                e.target.reset();
                cambiarCategoria();
                
            } catch (err) { 
                console.error('‚ùå Error:', err);
                alert("‚ùå Error: " + err.message); 
            } finally { 
                btn.innerText = "REGISTRAR EN SEGUIMIENTO"; 
                btn.disabled = false; 
            }
        });

        // ==================== LINA - TODO EL COMPILADO ====================
        async function cargarPendientesLina() {
            const tbody = document.getElementById('tabla-pendientes');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">Cargando...</td></tr>';
            
            const q = query(collection(db, 'registros_2024'), orderBy('fecha_recibido', 'desc'));
            const snapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-400">No hay solicitudes pendientes</td></tr>';
                return;
            }
            
            snapshot.forEach((docSnap) => {
                const d = docSnap.data();
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-blue-50 cursor-pointer transition";
                tr.onclick = () => abrirModalEvaluacion(docSnap.id, d);
                
                let estadoColor = d.estado_ciarp === "Aprobado" ? "bg-green-100 text-green-800" : 
                                 d.estado_ciarp === "Negado" ? "bg-red-100 text-red-800" : "bg-yellow-100 text-yellow-800";
                
                let puntajeColor = d.puntaje_asignado > 0 ? "bg-green-600 text-white" : "bg-gray-200 text-gray-700";

                tr.innerHTML = `
                    <td class="p-3 text-sm font-mono">${docSnap.id.substring(0, 8)}</td>
                    <td class="p-3 text-sm">${d.semestre || ''}-${d.anio || '2024'}</td>
                    <td class="p-3 text-sm font-bold">${d.autor}</td>
                    <td class="p-3 text-sm">${d.titulo_producto}</td>
                    <td class="p-3 text-sm">${d.categoria}</td>
                    <td class="p-3 text-sm"><span class="px-2 py-1 rounded text-xs font-bold ${estadoColor}">${d.estado_ciarp || 'Pendiente'}</span></td>
                    <td class="p-3 text-sm text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-bold ${puntajeColor}">
                            ${d.puntaje_asignado > 0 ? d.puntaje_asignado : 'Sin evaluar'}
                        </span>
                    </td>
                    <td class="p-3 text-sm text-center">
                        <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
                            Evaluar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // LINA: ABRIR MODAL CON TODA LA INFORMACI√ìN
        window.abrirModalEvaluacion = (id, data) => {
            idRegistroActual = id;
            document.getElementById('modal-evaluacion').classList.remove('hidden');
            
            // ========== SECCI√ìN JOS√â (SOLO LECTURA) ==========
            document.getElementById('info-id').innerText = id.substring(0, 8);
            document.getElementById('info-categoria').innerText = data.categoria;
            document.getElementById('info-titulo').innerText = data.titulo_producto;
            document.getElementById('info-autor').innerText = data.autor;
            document.getElementById('info-programa').innerText = data.programa;
            document.getElementById('info-fecha').innerText = data.fecha_recibido;
            document.getElementById('info-doc').innerText = data.doc_completa;
            document.getElementById('info-estado-jose').innerText = data.estado_ciarp || 'Pendiente';
            document.getElementById('info-obs-jose').innerText = data.observaciones_jose || 'Sin observaciones';
            
            // Mostrar campos espec√≠ficos de Jos√©
            mostrarCamposJoseReadonly(data);
            
            // ========== SECCI√ìN LINA (EDITABLES) ==========
            // Datos del docente
            document.getElementById('edit-documento').value = data.documento_id || "";
            document.getElementById('edit-escolaridad').value = data.escolaridad || "";
            document.getElementById('edit-categoria-doc').value = data.categoria_docente || "";
            document.getElementById('edit-dedicacion').value = data.dedicacion || "";
            document.getElementById('edit-facultad').value = data.facultad || "";
            
            // Campos espec√≠ficos seg√∫n categor√≠a
            cargarCamposLinaEspecificos(data);
            
            // Evaluaci√≥n
            document.getElementById('edit-puntaje-eval1').value = data.puntaje_eval1 || 0;
            document.getElementById('edit-puntaje-eval2').value = data.puntaje_eval2 || 0;
            document.getElementById('edit-puntaje-asignado').value = data.puntaje_asignado || 0;
            document.getElementById('edit-acta').value = data.acta_ciarp || "";
            document.getElementById('edit-resolucion').value = data.resolucion || "";
            document.getElementById('edit-obs-lina').value = data.observaciones_lina || "";
            
            calcularPromedio();
        };

        function mostrarCamposJoseReadonly(data) {
            const container = document.getElementById('campos-jose-readonly');
            let html = '<div class="space-y-2">';
            
            if (data.nombre_articulo) {
                html += `<div><span class="font-bold text-gray-600">Art√≠culo:</span> ${data.nombre_articulo}</div>`;
            }
            if (data.titulo_revista) {
                html += `<div><span class="font-bold text-gray-600">Revista:</span> ${data.titulo_revista}</div>`;
            }
            if (data.profesor_solicitante) {
                html += `<div><span class="font-bold text-gray-600">Solicitante:</span> ${data.profesor_solicitante}</div>`;
            }
            if (data.area_conocimiento) {
                html += `<div><span class="font-bold text-gray-600">√Årea:</span> ${data.area_conocimiento}</div>`;
            }
            if (data.premio_otorgado) {
                html += `<div><span class="font-bold text-gray-600">Premio:</span> ${data.premio_otorgado} (${data.fecha_premio || 'N/A'})</div>`;
            }
            if (data.concepto_comite) {
                html += `<div><span class="font-bold text-gray-600">Comit√© T√©cnico:</span> <span class="${data.concepto_comite === 'SI' ? 'text-green-600' : 'text-red-600'} font-bold">${data.concepto_comite}</span></div>`;
            }
            if (data.soportes_ok) {
                html += `<div><span class="font-bold text-gray-600">Soportes:</span> <span class="text-blue-600 font-bold">${data.soportes_ok}</span></div>`;
            }
            if (data.tipo_trabajo) {
                html += `<div><span class="font-bold text-gray-600">Ascenso:</span> ${data.categoria_actual || ''} ‚Üí ${data.categoria_solicitada || ''}</div>`;
            }
            
            html += '</div>';
            container.innerHTML = html || '<p class="text-gray-500 text-sm italic">Sin informaci√≥n adicional</p>';
        }

        function cargarCamposLinaEspecificos(data) {
            const container = document.getElementById('campos-lina-especificos');
            let html = '';
            
            switch(data.categoria) {
                case "Art√≠culos Indexados":
                    html = `
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">MODALIDAD</label>
                                <select id="edit-modalidad" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                                    <option value="">N/A</option>
                                    <option ${data.modalidad === 'Full paper' ? 'selected' : ''}>Full paper</option>
                                    <option ${data.modalidad === 'Short paper' ? 'selected' : ''}>Short paper</option>
                                    <option ${data.modalidad === 'Poster' ? 'selected' : ''}>Poster</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">TIPO</label>
                                <select id="edit-tipo" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                                    <option value="">N/A</option>
                                    <option ${data.tipo === 'Nacional' ? 'selected' : ''}>Nacional</option>
                                    <option ${data.tipo === 'Internacional' ? 'selected' : ''}>Internacional</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">PA√çS</label>
                                <input type="text" id="edit-pais" value="${data.pais || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ISSN</label>
                                <input type="text" id="edit-issn" value="${data.issn || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">CLASIFICACI√ìN</label>
                                <select id="edit-clasificacion" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                                    <option value="">N/A</option>
                                    <option ${data.clasificacion_publindex === 'A1' ? 'selected' : ''}>A1</option>
                                    <option ${data.clasificacion_publindex === 'A2' ? 'selected' : ''}>A2</option>
                                    <option ${data.clasificacion_publindex === 'B' ? 'selected' : ''}>B</option>
                                    <option ${data.clasificacion_publindex === 'C' ? 'selected' : ''}>C</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">EDITORIAL</label>
                                <input type="text" id="edit-editorial" value="${data.editorial || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">A√ëO PUBLICACI√ìN</label>
                                <input type="number" id="edit-anio-pub" value="${data.anio_publicacion || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">N√öM. AUTORES</label>
                                <input type="number" id="edit-num-autores" value="${data.num_autores || 0}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">UNIV. COAUTORES</label>
                                <input type="text" id="edit-universidades" value="${data.universidades_coautores || ''}" placeholder="UQ, UdeA..." class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                        </div>
                    `;
                    break;
                    
                case "Libro Investigaci√≥n":
                case "Libro Texto":
                case "Libro Ensayo":
                    html = `
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ISBN</label>
                                <input type="text" id="edit-isbn" value="${data.isbn || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">A√ëO PUBLICACI√ìN</label>
                                <input type="number" id="edit-anio-pub" value="${data.anio_publicacion || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">EDITORIAL</label>
                                <input type="text" id="edit-editorial" value="${data.editorial || ''}" class="w-full border-2 border-blue-200 p-2 rounded text-sm">
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    html = '<p class="text-gray-500 text-sm italic">Sin campos espec√≠ficos adicionales</p>';
            }
            
            container.innerHTML = html;
        }

        window.cerrarModal = () => {
            document.getElementById('modal-evaluacion').classList.add('hidden');
            idRegistroActual = null;
        };

        window.calcularPromedio = () => {
            const eval1 = parseFloat(document.getElementById('edit-puntaje-eval1').value) || 0;
            const eval2 = parseFloat(document.getElementById('edit-puntaje-eval2').value) || 0;
            const promedio = (eval1 + eval2) / 2;
            document.getElementById('puntaje-promedio-display').innerText = promedio.toFixed(2);
        };

        // LINA: GUARDAR COMPILADO COMPLETO
        window.guardarEvaluacion = async () => {
            if(!idRegistroActual) return;
            
            const btn = document.getElementById('btn-guardar-lina');
            btn.innerText = "GUARDANDO...";
            btn.disabled = true;
            
            // Obtener datos originales para t√≠tulo y autor
            const docRef = doc(db, 'registros_2024', idRegistroActual);
            const docSnap = await getDocs(query(collection(db, 'registros_2024'), where("__name__", "==", idRegistroActual)));
            const dataOriginal = docSnap.docs[0]?.data() || {};
            
            const eval1 = parseFloat(document.getElementById('edit-puntaje-eval1').value) || 0;
            const eval2 = parseFloat(document.getElementById('edit-puntaje-eval2').value) || 0;
            const promedio = (eval1 + eval2) / 2;
            
            // LINA ENV√çA TODOS LOS DATOS (INCLUYENDO LOS DE JOS√â PARA IDENTIFICACI√ìN)
            const actualizacion = {
                // Datos de Jos√© (para identificaci√≥n)
                titulo_producto: dataOriginal.titulo_producto || "",
                autor: dataOriginal.autor || "",
                categoria: dataOriginal.categoria || "",
                
                // Datos de Lina (compilado)
                documento_id: document.getElementById('edit-documento').value,
                escolaridad: document.getElementById('edit-escolaridad').value,
                categoria_docente: document.getElementById('edit-categoria-doc').value,
                dedicacion: document.getElementById('edit-dedicacion').value,
                facultad: document.getElementById('edit-facultad').value,
                puntaje_eval1: eval1,
                puntaje_eval2: eval2,
                puntaje_promedio: promedio,
                puntaje_asignado: parseFloat(document.getElementById('edit-puntaje-asignado').value) || 0,
                acta_ciarp: document.getElementById('edit-acta').value,
                resolucion: document.getElementById('edit-resolucion').value,
                observaciones_lina: document.getElementById('edit-obs-lina').value,
                
                // Campos espec√≠ficos seg√∫n categor√≠a
                modalidad: document.getElementById('edit-modalidad')?.value || "",
                tipo: document.getElementById('edit-tipo')?.value || "",
                pais: document.getElementById('edit-pais')?.value || "",
                issn: document.getElementById('edit-issn')?.value || "",
                clasificacion_publindex: document.getElementById('edit-clasificacion')?.value || "",
                editorial: document.getElementById('edit-editorial')?.value || "",
                anio_publicacion: document.getElementById('edit-anio-pub')?.value || "",
                isbn: document.getElementById('edit-isbn')?.value || "",
                num_autores: parseInt(document.getElementById('edit-num-autores')?.value) || 0,
                universidades_coautores: document.getElementById('edit-universidades')?.value || ""
            };

            try {
                // Actualizar en Firebase
                await updateDoc(docRef, actualizacion);
                
                // Sincronizar con Google Sheets (LINA env√≠a todo)
                const response = await fetch(urlAppsScript, {
                    method: 'POST',
                    body: JSON.stringify(actualizacion),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                console.log('‚úÖ Google Sheets actualizado:', result);
                
                alert("‚úÖ Compilado guardado correctamente");
                cerrarModal();
                cargarPendientesLina();
                
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert("‚ùå Error al guardar: " + err.message);
            } finally {
                btn.innerText = "üíæ GUARDAR EN COMPILADO";
                btn.disabled = false;
            }
        };

        window.descargarExcel = async () => {
            const snapshot = await getDocs(collection(db, 'registros_2024'));
            const datos = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                datos.push({
                    "ID": doc.id.substring(0, 8),
                    "A√±o": d.anio,
                    "Semestre": d.semestre,
                    "Categor√≠a": d.categoria,
                    "Fecha Recibido": d.fecha_recibido,
                    "T√≠tulo": d.titulo_producto,
                    "Autor": d.autor,
                    "Programa": d.programa,
                    "Estado CIARP": d.estado_ciarp,
                    "Doc ID": d.documento_id,
                    "Escolaridad": d.escolaridad,
                    "Categor√≠a Docente": d.categoria_docente,
                    "Dedicaci√≥n": d.dedicacion,
                    "Facultad": d.facultad,
                    "Puntaje Eval 1": d.puntaje_eval1,
                    "Puntaje Eval 2": d.puntaje_eval2,
                    "Promedio": d.puntaje_promedio,
                    "Puntaje Asignado": d.puntaje_asignado,
                    "Acta CIARP": d.acta_ciarp,
                    "Resoluci√≥n": d.resolucion,
                    "Observaciones Lina": d.observaciones_lina
                });
            });
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Compilado 2024");
            XLSX.writeFile(wb, `Compilado_Productividad_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // Inicializar Firebase y sistema
        signInAnonymously(auth).then(() => {
            console.log('‚úÖ Firebase conectado');
        }).catch(err => {
            console.error('‚ùå Error Firebase:', err);
        });
        
        window.onload = () => {
            console.log('‚úÖ Sistema cargado');
        };
    </script>
</head>
<body class="bg-gray-100 font-sans h-screen flex flex-col">
    <!-- HEADER -->
    <div id="header-bg" class="text-white p-4 shadow-lg flex justify-between items-center transition-colors">
        <div>
            <h1 id="header-title" class="text-xl font-black tracking-wider">SISTEMA PRODUCTIVIDAD UQ</h1>
            <p class="text-[10px] opacity-75">Universidad del Quind√≠o - 2024 - VERSI√ìN MEJORADA</p>
        </div>
        <button onclick="location.reload()" class="text-xs bg-white/20 px-3 py-1 rounded hover:bg-white/40">Cerrar Sesi√≥n</button>
    </div>

    <!-- PANTALLA LOGIN -->
    <div id="pantalla-login" class="flex-1 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full">
            <div class="mb-8">
                <div class="text-4xl mb-3">üîê</div>
                <h2 class="text-2xl font-bold text-gray-700">Acceso al Sistema</h2>
                <p class="text-xs text-gray-500 mt-2">Universidad del Quind√≠o - CIARP</p>
            </div>
            
            <div class="bg-green-50 p-5 rounded-xl mb-4 border-2 border-green-200">
                <div class="font-black text-lg text-green-800 mb-3">üë§ JOS√â</div>
                <p class="text-xs text-gray-600 mb-3">Solo ingresa datos de SEGUIMIENTO</p>
                <input type="password" id="password-jose" placeholder="Contrase√±a" 
                    class="w-full p-3 border-2 border-green-300 rounded-lg mb-3 focus:outline-none focus:border-green-600"
                    onkeypress="if(event.key==='Enter') intentarLogin('JOSE')">
                <button onclick="intentarLogin('JOSE')" 
                    class="w-full bg-[#003d2b] hover:bg-green-900 text-white p-3 rounded-lg font-bold transition">
                    INGRESAR COMO JOS√â
                </button>
            </div>

            <div class="bg-blue-50 p-5 rounded-xl border-2 border-blue-200">
                <div class="font-black text-lg text-blue-800 mb-3">üë§ LINA</div>
                <p class="text-xs text-gray-600 mb-3">Ve y edita TODO el compilado</p>
                <input type="password" id="password-lina" placeholder="Contrase√±a" 
                    class="w-full p-3 border-2 border-blue-300 rounded-lg mb-3 focus:outline-none focus:border-blue-600"
                    onkeypress="if(event.key==='Enter') intentarLogin('LINA')">
                <button onclick="intentarLogin('LINA')" 
                    class="w-full bg-blue-800 hover:bg-blue-900 text-white p-3 rounded-lg font-bold transition">
                    INGRESAR COMO LINA
                </button>
            </div>
        </div>
    </div>

    <!-- PANEL JOS√â (SOLO SEGUIMIENTO) -->
    <div id="panel-jose" class="hidden flex-1 overflow-auto p-4 md:p-8">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
            <div class="bg-green-50 p-4 border-b">
                <div class="flex items-center gap-3">
                    <div class="bg-[#003d2b] text-white p-2 rounded-lg">üë§</div>
                    <div>
                        <h3 class="text-green-800 font-bold text-lg">üìù REGISTRO DE SEGUIMIENTO (JOS√â)</h3>
                        <p class="text-xs text-gray-600">Solo llena los campos de seguimiento inicial</p>
                    </div>
                </div>
            </div>
            
            <form id="form-jose" class="p-6 space-y-5">
                <!-- DATOS B√ÅSICOS -->
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">SEMESTRE</label>
                        <select id="semestre" required class="w-full border-2 p-2 rounded font-bold">
                            <option>I</option>
                            <option>II</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">FECHA RECIBIDO</label>
                        <input type="date" id="fecha_recibido" required class="w-full border-2 p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">CATEGOR√çA</label>
                        <select id="categoria" onchange="cambiarCategoria()" required class="w-full border-2 p-2 rounded font-bold text-xs">
                            <option value="">Seleccionar categor√≠a</option>
                            <option value="Art√≠culos Indexados">Art√≠culos Indexados</option>
                            <option value="Art√≠culos No Indexados">Art√≠culos No Indexados</option>
                            <option value="Libro Investigaci√≥n">Libro Investigaci√≥n</option>
                            <option value="Libro Texto">Libro Texto</option>
                            <option value="Libro Ensayo">Libro Ensayo</option>
                            <option value="Premio">Premio</option>
                            <option value="Software">Software</option>
                            <option value="Patente">Patente</option>
                            <option value="Obra Art√≠stica">Obra Art√≠stica</option>
                            <option value="Producci√≥n Audiovisual">Producci√≥n Audiovisual</option>
                            <option value="Ponencias">Ponencias</option>
                            <option value="Tesis">Tesis (Maestr√≠a/Doctorado)</option>
                            <option value="T√≠tulos">T√≠tulos</option>
                            <option value="Ascensos">Ascensos</option>
                        </select>
                    </div>
                </div>

                <!-- T√çTULO Y AUTOR -->
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">T√çTULO DEL PRODUCTO</label>
                    <input type="text" id="titulo_producto" required class="w-full border-2 p-2 rounded" placeholder="Nombre completo del producto acad√©mico">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">AUTOR/DOCENTE</label>
                        <input type="text" id="autor" required class="w-full border-2 p-2 rounded" placeholder="Nombre completo">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">PROGRAMA ACAD√âMICO</label>
                        <input type="text" id="programa" required class="w-full border-2 p-2 rounded" placeholder="Programa al que pertenece">
                    </div>
                </div>

                <!-- CAMPOS ESPEC√çFICOS DE JOS√â -->
                <div class="bg-green-50 p-4 rounded border-2 border-green-200">
                    <p class="text-xs font-bold text-green-800 mb-2">üìã CAMPOS ESPEC√çFICOS SEG√öN CATEGOR√çA</p>
                    <div id="campos-jose-especificos">
                        <!-- Se carga din√°micamente -->
                    </div>
                </div>

                <!-- ESTADO Y OBSERVACIONES -->
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">DOC. COMPLETA</label>
                        <select id="doc_completa" class="w-full border-2 p-2 rounded font-bold">
                            <option>SI</option>
                            <option>NO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">ESTADO INICIAL</label>
                        <select id="estado_inicial" class="w-full border-2 p-2 rounded font-bold">
                            <option>Pendiente</option>
                            <option>Aprobado</option>
                            <option>Negado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">OBSERVACIONES JOS√â</label>
                        <input type="text" id="observaciones_jose" placeholder="Opcional" class="w-full border-2 p-2 rounded">
                    </div>
                </div>

                <button type="submit" id="btn-jose" class="w-full bg-[#003d2b] text-white py-3 rounded-lg font-bold hover:bg-black transition shadow-lg">
                    ‚úÖ REGISTRAR EN SEGUIMIENTO
                </button>
            </form>
        </div>
    </div>

    <!-- PANEL LINA (TODO EL COMPILADO) -->
    <div id="panel-lina" class="hidden flex-1 overflow-auto p-4 md:p-8">
        <div class="max-w-full mx-auto space-y-6 px-4">
            <!-- HEADER LINA -->
            <div class="flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-900 text-white p-2 rounded-lg">üë§</div>
                        <div>
                            <h2 class="text-2xl font-bold text-blue-900">üìä COMPILADO DE PRODUCTIVIDAD (LINA)</h2>
                            <p class="text-sm text-gray-600">Ve y edita toda la informaci√≥n - Liquidaci√≥n completa</p>
                        </div>
                    </div>
                </div>
                <button onclick="descargarExcel()" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow hover:bg-green-700 font-bold flex items-center gap-2">
                    <span>üì•</span> Exportar Excel
                </button>
            </div>

            <!-- TABLA DE SOLICITUDES -->
            <div class="bg-white rounded-xl shadow-xl overflow-hidden overflow-x-auto">
                <table class="w-full min-w-[1000px]">
                    <thead class="bg-blue-900 text-white text-xs font-bold uppercase">
                        <tr>
                            <th class="p-3 text-left">ID</th>
                            <th class="p-3 text-left">Per√≠odo</th>
                            <th class="p-3 text-left">Docente</th>
                            <th class="p-3 text-left">Producto</th>
                            <th class="p-3 text-left">Categor√≠a</th>
                            <th class="p-3 text-left">Estado</th>
                            <th class="p-3 text-center">Puntaje</th>
                            <th class="p-3 text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pendientes"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL LINA (EVALUACI√ìN COMPLETA) -->
    <div id="modal-evaluacion" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl my-8 max-h-[90vh] flex flex-col">
            <!-- HEADER MODAL -->
            <div class="bg-blue-900 text-white p-4 flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">üìä</div>
                    <div>
                        <h3 class="font-bold text-lg">COMPILADO Y LIQUIDACI√ìN COMPLETA</h3>
                        <p class="text-xs opacity-80">Lina: Verifica y completa toda la informaci√≥n</p>
                    </div>
                </div>
                <button onclick="cerrarModal()" class="text-3xl hover:text-gray-300">&times;</button>
            </div>
            
            <!-- CONTENIDO MODAL -->
            <div class="p-6 space-y-6 overflow-y-auto flex-1">
                <!-- SECCI√ìN 1: DATOS DE JOS√â (SOLO LECTURA) -->
                <div class="bg-green-50 p-5 rounded-lg border-2 border-green-200">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="bg-[#003d2b] text-white p-1 rounded">üë§</div>
                        <h4 class="font-bold text-green-800 text-lg">DATOS DE SEGUIMIENTO (JOS√â)</h4>
                        <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded ml-auto">SOLO LECTURA</span>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 text-sm">
                        <div><span class="font-bold text-gray-600">ID:</span> <span id="info-id" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></div>
                        <div><span class="font-bold text-gray-600">Categor√≠a:</span> <span id="info-categoria" class="text-gray-900"></span></div>
                        <div><span class="font-bold text-gray-600">Fecha Recibido:</span> <span id="info-fecha" class="text-gray-900"></span></div>
                        <div><span class="font-bold text-gray-600">Doc. Completa:</span> <span id="info-doc" class="font-bold"></span></div>
                        
                        <div class="col-span-2"><span class="font-bold text-gray-600">T√≠tulo:</span> <span id="info-titulo" class="text-gray-900"></span></div>
                        <div><span class="font-bold text-gray-600">Docente:</span> <span id="info-autor" class="text-gray-900"></span></div>
                        <div><span class="font-bold text-gray-600">Programa:</span> <span id="info-programa" class="text-gray-900"></span></div>
                        
                        <div class="col-span-4 border-t pt-3 mt-2">
                            <span class="font-bold text-gray-600">Informaci√≥n Espec√≠fica:</span>
                            <div id="campos-jose-readonly" class="mt-2 p-3 bg-white rounded border"></div>
                        </div>
                        
                        <div class="col-span-2"><span class="font-bold text-gray-600">Estado Inicial:</span> <span id="info-estado-jose" class="font-bold text-lg"></span></div>
                        <div class="col-span-2"><span class="font-bold text-gray-600">Observaciones Jos√©:</span> <span id="info-obs-jose" class="text-gray-600 italic"></span></div>
                    </div>
                </div>

                <!-- SECCI√ìN 2: DATOS DE LINA (EDITABLES) -->
                <div class="bg-blue-50 p-5 rounded-lg border-2 border-blue-200">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="bg-blue-900 text-white p-1 rounded">üë§</div>
                        <h4 class="font-bold text-blue-900 text-lg">DATOS DE COMPILADO (LINA)</h4>
                        <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded ml-auto">EDITABLE</span>
                    </div>
                    
                    <!-- INFORMACI√ìN DEL DOCENTE -->
                    <div class="mb-6">
                        <p class="text-sm font-bold text-gray-700 mb-3 border-b pb-2">üë§ INFORMACI√ìN DEL DOCENTE</p>
                        <div class="grid grid-cols-5 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">DOC. IDENTIDAD</label>
                                <input type="text" id="edit-documento" class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ESCOLARIDAD</label>
                                <select id="edit-escolaridad" class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                                    <option value="">Seleccionar</option>
                                    <option>Pregrado</option>
                                    <option>Especializaci√≥n</option>
                                    <option>Maestr√≠a</option>
                                    <option>Doctorado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">CATEGOR√çA DOCENTE</label>
                                <select id="edit-categoria-doc" class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                                    <option value="">Seleccionar</option>
                                    <option>Auxiliar</option>
                                    <option>Asistente</option>
                                    <option>Asociado</option>
                                    <option>Titular</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">DEDICACI√ìN</label>
                                <select id="edit-dedicacion" class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                                    <option value="">Seleccionar</option>
                                    <option>TC</option>
                                    <option>MT</option>
                                    <option>C√°tedra</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">FACULTAD</label>
                                <input type="text" id="edit-facultad" class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- CAMPOS ESPEC√çFICOS LINA -->
                    <div class="mb-6">
                        <p class="text-sm font-bold text-gray-700 mb-3 border-b pb-2">üìã INFORMACI√ìN ESPEC√çFICA DEL PRODUCTO</p>
                        <div id="campos-lina-especificos">
                            <!-- Se carga din√°micamente seg√∫n categor√≠a -->
                        </div>
                    </div>
                    
                    <!-- EVALUACI√ìN Y PUNTAJES -->
                    <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300 mb-6">
                        <p class="text-sm font-bold text-yellow-900 mb-4 flex items-center gap-2">
                            <span>‚≠ê</span> EVALUACI√ìN Y LIQUIDACI√ìN DE PUNTAJES
                        </p>
                        <div class="grid grid-cols-5 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">PUNTAJE EVAL 1</label>
                                <input type="number" step="0.1" id="edit-puntaje-eval1" oninput="calcularPromedio()" 
                                       class="w-full border-2 border-yellow-400 p-2 rounded font-bold text-center text-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">PUNTAJE EVAL 2</label>
                                <input type="number" step="0.1" id="edit-puntaje-eval2" oninput="calcularPromedio()" 
                                       class="w-full border-2 border-yellow-400 p-2 rounded font-bold text-center text-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">PROMEDIO</label>
                                <div class="w-full border-2 border-yellow-400 bg-yellow-100 p-2 rounded font-bold text-center text-2xl" 
                                     id="puntaje-promedio-display">0.00</div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">PUNTAJE FINAL</label>
                                <input type="number" step="0.1" id="edit-puntaje-asignado" 
                                       class="w-full border-2 border-green-500 bg-green-50 p-2 rounded font-bold text-center text-2xl text-green-700">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ACTA CIARP</label>
                                <input type="text" id="edit-acta" placeholder="N√∫mero de acta" 
                                       class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- RESOLUCI√ìN Y OBSERVACIONES -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">RESOLUCI√ìN</label>
                            <input type="text" id="edit-resolucion" placeholder="R.R. No..." 
                                   class="w-full border-2 border-blue-300 p-2 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">OBSERVACIONES T√âCNICAS (LINA)</label>
                            <textarea id="edit-obs-lina" rows="3" 
                                      class="w-full border-2 border-blue-300 p-2 rounded text-sm"
                                      placeholder="Observaciones para el compilado..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- BOT√ìN GUARDAR -->
                <button id="btn-guardar-lina" onclick="guardarEvaluacion()" 
                        class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold hover:bg-blue-950 transition text-lg shadow-lg flex items-center justify-center gap-3">
                    <span>üíæ</span> GUARDAR COMPILADO COMPLETO
                </button>
            </div>
        </div>
    </div>

</body>
</html>

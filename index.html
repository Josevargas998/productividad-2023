<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Productividad UQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbqMf8ZOmqmbGTmr2tr8nziyUWKSE6OWg",
            authDomain: "uniquindio-produccion.firebaseapp.com",
            projectId: "uniquindio-produccion",
            storageBucket: "uniquindio-produccion.firebasestorage.app",
            messagingSenderId: "440871309124",
            appId: "1:440871309124:web:108be1894adaf6ecaf1111"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'uniquindio-produccion';

        // L√≥gica de interfaz: Cambiar campos seg√∫n lo que se elija
        window.cambiarCategoria = () => {
            const cat = document.getElementById('categoria').value;
            const camposExtra = document.getElementById('campos-dinamicos');
            
            if (cat === 'Articulo') {
                camposExtra.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">ISSN Revista</label>
                            <input type="text" id="issn" placeholder="Ej: 1932-8540" class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border focus:ring-2 focus:ring-green-600 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Categor√≠a</label>
                            <select id="r_cat" class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border outline-none">
                                <option>A1</option><option>A2</option><option>B</option><option>C</option><option>No Indexada</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Nombre de la Revista</label>
                        <input type="text" id="revista" class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border focus:ring-2 focus:ring-green-600 outline-none">
                    </div>`;
            } else if (cat === 'LibroTexto') {
                camposExtra.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">ISBN</label>
                        <input type="text" id="isbn" placeholder="Ej: 978-628..." class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border focus:ring-2 focus:ring-green-600 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Espacio Acad√©mico</label>
                        <input type="text" id="espacio" placeholder="Nombre de la asignatura" class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border focus:ring-2 focus:ring-green-600 outline-none">
                    </div>`;
            } else {
                camposExtra.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">ISBN</label>
                        <input type="text" id="isbn" class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Programa Acad√©mico</label>
                        <input type="text" id="programa" placeholder="Ej: Medicina, Ingenier√≠a..." class="mt-1 block w-full rounded-lg border-gray-300 p-2 bg-gray-50 border">
                    </div>`;
            }
        };

        // Autenticaci√≥n y Contador en tiempo real
        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registros_detallados'));
                onSnapshot(q, (snapshot) => {
                    document.getElementById('record-count').innerText = snapshot.size;
                });
            }
        });

        // Guardar en Firebase
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            const datos = {
                categoria: document.getElementById('categoria').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                facultad: document.getElementById('facultad').value,
                anio: document.getElementById('anio').value,
                createdAt: serverTimestamp(),
                // Captura din√°mica seg√∫n los campos que existan en ese momento
                issn: document.getElementById('issn')?.value || '',
                cat_revista: document.getElementById('r_cat')?.value || '',
                revista: document.getElementById('revista')?.value || '',
                isbn: document.getElementById('isbn')?.value || '',
                espacio_academico: document.getElementById('espacio')?.value || '',
                programa: document.getElementById('programa')?.value || ''
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registros_detallados'), datos);
                e.target.reset();
                window.cambiarCategoria();
                alert("‚úÖ Registro guardado correctamente");
            } catch (e) { alert("‚ùå Error al guardar"); }
            finally { 
                btn.disabled = false; 
                btn.innerText = "GUARDAR REGISTRO"; 
            }
        });

        // EXPORTAR EXCEL CON PESTA√ëAS (HOJAS)
        window.exportarExcelFinal = async () => {
            const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'registros_detallados'));
            
            const revistas = [];
            const libroTexto = [];
            const libroEnsayo = [];

            querySnapshot.forEach((doc) => {
                const d = doc.data();
                const base = { A√ëO: d.anio, T√çTULO: d.titulo, AUTOR: d.autor, FACULTAD: d.facultad };

                if (d.categoria === 'Articulo') {
                    revistas.push({ ...base, ISSN: d.issn, REVISTA: d.revista, CATEGORIA: d.cat_revista });
                } else if (d.categoria === 'LibroTexto') {
                    libroTexto.push({ ...base, ISBN: d.isbn, "ESPACIO ACAD√âMICO": d.espacio_academico });
                } else {
                    libroEnsayo.push({ ...base, ISBN: d.isbn, PROGRAMA: d.programa });
                }
            });

            const wb = XLSX.utils.book_new();
            
            if(revistas.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(revistas), "Publicac. Rev. Index");
            if(libroTexto.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(libroTexto), "Libro Texto");
            if(libroEnsayo.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(libroEnsayo), "Libro Ensayo");

            XLSX.writeFile(wb, "Compilado_Productividad_2024.xlsx");
        };

        window.onload = window.cambiarCategoria;
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-2xl mx-auto space-y-6">
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-black text-green-900 leading-tight">UniQuind√≠o</h1>
                <p class="text-xs font-bold text-green-700 uppercase tracking-widest">Productividad Acad√©mica</p>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-center">
                    <div class="text-3xl font-black text-gray-800" id="record-count">0</div>
                    <div class="text-[10px] text-gray-400 font-bold uppercase">Total</div>
                </div>
                <button onclick="exportarExcelFinal()" class="bg-green-800 hover:bg-green-900 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-green-100 transition-all">
                    üìä DESCARGAR EXCEL
                </button>
            </div>
        </div>

        <form id="product-form" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 space-y-6">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">¬øQu√© vas a registrar?</label>
                <select id="categoria" onchange="cambiarCategoria()" class="w-full rounded-xl border-gray-200 p-4 bg-gray-50 border-2 focus:border-green-800 outline-none font-medium">
                    <option value="Articulo">Publicaci√≥n en Revista Indexada</option>
                    <option value="LibroTexto">Libro de Texto</option>
                    <option value="LibroEnsayo">Libro de Ensayo</option>
                </select>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">T√≠tulo de la Obra</label>
                    <input type="text" id="titulo" required class="mt-1 w-full rounded-lg border-gray-300 p-3 bg-gray-50 border focus:ring-2 focus:ring-green-600 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Autor Principal</label>
                    <input type="text" id="autor" required class="mt-1 w-full rounded-lg border-gray-300 p-3 bg-gray-50 border focus:ring-2 focus:ring-green-600 outline-none">
                </div>
            </div>

            <div id="campos-dinamicos" class="bg-green-50/50 p-5 rounded-2xl border border-green-100 space-y-4"></div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Facultad</label>
                    <select id="facultad" class="mt-1 w-full rounded-lg border-gray-300 p-3 bg-gray-50 border outline-none">
                        <option>Ingenier√≠a</option>
                        <option>Educaci√≥n</option>
                        <option>Ciencias de la Salud</option>
                        <option>Ciencias B√°sicas</option>
                        <option>Ciencias Humanas</option>
                        <option>Econom√≠a y Administraci√≥n</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">A√±o</label>
                    <input type="number" id="anio" value="2024" class="mt-1 w-full rounded-lg border-gray-300 p-3 bg-gray-50 border outline-none">
                </div>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-green-800 text-white font-black py-5 rounded-2xl shadow-xl hover:shadow-green-200 transition-all uppercase tracking-widest">
                Guardar Registro
            </button>
        </form>

        <p class="text-center text-[10px] text-gray-300 font-bold uppercase tracking-[0.3em]">
            Universidad del Quind√≠o ‚Ä¢ 2024
        </p>
    </div>
</body>
</html>

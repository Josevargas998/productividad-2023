<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Productividad - Uniquindio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIGURACIÃ“N (Tus llaves de Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSyBbqMf8ZOmqmbGTmr2tr8nziyUWKSE6OWg",
            authDomain: "uniquindio-produccion.firebaseapp.com",
            projectId: "uniquindio-produccion",
            storageBucket: "uniquindio-produccion.firebasestorage.app",
            messagingSenderId: "440871309124",
            appId: "1:440871309124:web:108be1894adaf6ecaf1111"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'uniquindio-produccion';

        // LÃ³gica para cambiar campos segÃºn categorÃ­a
        window.cambiarCategoria = () => {
            const cat = document.getElementById('categoria').value;
            const camposExtra = document.getElementById('campos-dinamicos');
            
            if (cat === 'Articulo') {
                camposExtra.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ISSN</label>
                            <input type="text" id="issn" placeholder="Ej: 1932-8540" class="mt-1 block w-full rounded-md border-gray-300 p-2 bg-gray-50 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">CategorÃ­a Revista</label>
                            <select id="r_cat" class="mt-1 block w-full rounded-md border-gray-300 p-2 bg-gray-50 border">
                                <option>A1</option><option>A2</option><option>B</option><option>C</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre de la Revista</label>
                        <input type="text" id="revista" class="mt-1 block w-full rounded-md border-gray-300 p-2 bg-gray-50 border">
                    </div>`;
            } else {
                camposExtra.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ISBN</label>
                        <input type="text" id="isbn" placeholder="Ej: 978-628..." class="mt-1 block w-full rounded-md border-gray-300 p-2 bg-gray-50 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Espacio AcadÃ©mico / Programa</label>
                        <input type="text" id="espacio" class="mt-1 block w-full rounded-md border-gray-300 p-2 bg-gray-50 border">
                    </div>`;
            }
        };

        // AutenticaciÃ³n y Contador
        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registros_detallados'));
                onSnapshot(q, (snapshot) => {
                    document.getElementById('record-count').innerText = snapshot.size;
                });
            }
        });

        // Guardar Datos
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button');
            submitBtn.disabled = true;
            submitBtn.innerText = "Guardando...";

            const cat = document.getElementById('categoria').value;
            const datos = {
                categoria: cat,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                facultad: document.getElementById('facultad').value,
                anio: document.getElementById('anio').value,
                createdAt: serverTimestamp(),
                // Campos condicionales
                issn: document.getElementById('issn')?.value || '',
                revista: document.getElementById('revista')?.value || '',
                cat_revista: document.getElementById('r_cat')?.value || '',
                isbn: document.getElementById('isbn')?.value || '',
                espacio_academico: document.getElementById('espacio')?.value || ''
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registros_detallados'), datos);
                e.target.reset();
                window.cambiarCategoria();
                alert("âœ… Â¡Guardado!");
            } catch (error) {
                console.error(error);
                alert("âŒ Error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = "Guardar Registro";
            }
        });

        // Exportar a Excel (CSV) con todas las columnas
        window.exportarExcel = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registros_detallados'));
            onSnapshot(q, (snapshot) => {
                let csv = "CategorÃ­a,TÃ­tulo,Autor,Facultad,AÃ±o,ISSN/ISBN,Revista/Programa,Cat Revista\n";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const id_numero = d.issn || d.isbn || '';
                    const lugar = d.revista || d.espacio_academico || '';
                    csv += `"${d.categoria}","${d.titulo}","${d.autor}","${d.facultad}",${d.anio},"${id_numero}","${lugar}","${d.cat_revista || ''}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "Productividad_Uniquindio.csv";
                link.click();
            }, { once: true });
        };

        window.onload = window.cambiarCategoria;
    </script>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white p-6 rounded-xl shadow-md border-t-8 border-green-800 mb-6 text-center">
            <h1 class="text-2xl font-bold text-gray-800">Universidad del QuindÃ­o</h1>
            <p class="text-gray-600">GestiÃ³n de Productividad AcadÃ©mica</p>
            
            <div class="mt-4 flex items-center justify-between bg-green-50 p-4 rounded-lg">
                <div class="text-left">
                    <span class="text-xs text-green-700 font-bold uppercase">Registros</span>
                    <div class="text-3xl font-black text-green-900" id="record-count">0</div>
                </div>
                <button onclick="exportarExcel()" class="bg-white border border-green-200 text-green-700 px-4 py-2 rounded-lg shadow-sm hover:bg-green-100 font-bold transition-all">
                    ðŸ“Š Descargar para Excel
                </button>
            </div>
        </div>

        <form id="product-form" class="bg-white p-8 rounded-xl shadow-md space-y-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 uppercase">Tipo de Producto</label>
                <select id="categoria" onchange="cambiarCategoria()" class="mt-1 block w-full rounded-md border-gray-300 p-3 bg-gray-50 border focus:ring-2 focus:ring-green-800 outline-none">
                    <option value="Articulo">Articulo en Revista Indexada ðŸ“‘</option>
                    <option value="Libro">Libro de Texto / Ensayo ðŸ“–</option>
                </select>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">TÃ­tulo de la Obra</label>
                    <input type="text" id="titulo" required class="mt-1 block w-full rounded-md border-gray-300 p-3 bg-gray-50 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Autor / Investigador</label>
                    <input type="text" id="autor" required class="mt-1 block w-full rounded-md border-gray-300 p-3 bg-gray-50 border">
                </div>
            </div>

            <div id="campos-dinamicos" class="bg-blue-50/50 p-4 rounded-xl space-y-4 border border-blue-100"></div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Facultad</label>
                    <select id="facultad" class="mt-1 block w-full rounded-md border-gray-300 p-3 bg-gray-50 border">
                        <option>IngenierÃ­a</option><option>EducaciÃ³n</option><option>Ciencias de la Salud</option>
                        <option>Ciencias BÃ¡sicas</option><option>Ciencias Humanas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">AÃ±o</label>
                    <input type="number" id="anio" value="2024" class="mt-1 block w-full rounded-md border-gray-300 p-3 bg-gray-50 border">
                </div>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-green-800 text-white font-black py-4 rounded-xl hover:bg-green-900 transition-all shadow-lg uppercase tracking-widest">
                Guardar Registro
            </button>
        </form>
    </div>
</body>
</html>

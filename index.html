<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Productividad UQ 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbqMf8ZOmqmbGTmr2tr8nziyUWKSE6OWg",
            authDomain: "uniquindio-produccion.firebaseapp.com",
            projectId: "uniquindio-produccion",
            storageBucket: "uniquindio-produccion.firebasestorage.app",
            messagingSenderId: "440871309124",
            appId: "1:440871309124:web:108be1894adaf6ecaf1111"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // URL DEL SCRIPT DE DRIVE (Solo se usa cuando Jose crea el registro)
        const urlAppsScript = "https://script.google.com/macros/s/AKfycbyKD0JyxaTKS6u3WXnJYgZl3aR5XEJ3v7DlbDOBBqk8KG4FYT5Wc23AqPIZf0vWAVND7g/exec";

        let rolActual = ''; 

        // --- SISTEMA DE NAVEGACI√ìN Y LOGIN ---
        window.iniciarSesion = (rol) => {
            rolActual = rol;
            document.getElementById('pantalla-login').classList.add('hidden');
            
            if (rol === 'JOSE') {
                document.getElementById('panel-jose').classList.remove('hidden');
                document.getElementById('header-title').innerText = "M√ìDULO DE RADICACI√ìN (JOSE)";
                document.getElementById('header-bg').classList.add('bg-[#003d2b]');
            } else {
                document.getElementById('panel-lina').classList.remove('hidden');
                document.getElementById('header-title').innerText = "M√ìDULO DE EVALUACI√ìN CIARP (LINA)";
                document.getElementById('header-bg').classList.add('bg-blue-900');
                cargarPendientesLina();
            }
        };

        // --- L√ìGICA DE JOSE (CREAR) ---
        window.cambiarCategoria = () => {
            const cat = document.getElementById('categoria').value;
            const container = document.getElementById('campos-especificos');
            let html = '';
            // Estilos para inputs de Jose
            const inputClass = "w-full p-2 border border-gray-300 rounded focus:border-green-600 outline-none";
            const labelClass = "block text-xs font-bold text-gray-500 uppercase mb-1";

            if (cat.includes("Rev")) {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">ISSN</label><input type="text" id="codigo_id" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Nombre Revista</label><input type="text" id="lugar_publicacion" class="${inputClass}"></div>
                    <div class="col-span-2"><label class="${labelClass}">Modalidad</label><input type="text" id="modalidad" placeholder="Full paper / Review" class="${inputClass}"></div>
                </div>`;
            } else if (cat.includes("Ponencia")) {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="${labelClass}">Evento</label><input type="text" id="lugar_publicacion" class="${inputClass}"></div>
                    <div><label class="${labelClass}">Tipo (Nac/Int)</label><select id="modalidad" class="${inputClass}"><option>Nacional</option><option>Internacional</option></select></div>
                </div>`;
            } else {
                html = `<div><label class="${labelClass}">Detalle Adicional</label><input type="text" id="codigo_id" class="${inputClass}"></div>`;
            }
            container.innerHTML = html;
        };

        document.getElementById('form-jose').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-jose');
            btn.innerText = "ENVIANDO..."; btn.disabled = true;

            const registro = {
                // Datos Fase 1 (Jose)
                categoria_pestana: document.getElementById('categoria').value,
                anio: document.getElementById('anio').value,
                semestre: document.getElementById('semestre').value,
                fecha_solicitud: document.getElementById('fecha_solicitud').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                documento: document.getElementById('documento').value,
                pais: document.getElementById('pais').value,
                programa: document.getElementById('programa').value,
                facultad: document.getElementById('facultad').value,
                dedicacion: document.getElementById('dedicacion').value,
                codigo_id: document.getElementById('codigo_id')?.value || '',
                lugar_publicacion: document.getElementById('lugar_publicacion')?.value || '',
                modalidad: document.getElementById('modalidad')?.value || '',
                
                // Datos Fase 2 (Lina) - Inicialmente vac√≠os
                estado: "EN TR√ÅMITE",
                puntos_asignados: 0,
                acta_ciarp: "",
                resolucion: "",
                observaciones: "",
                fecha_creacion: serverTimestamp()
            };

            try {
                // 1. Guardar en Firebase (Base de Datos Maestra)
                await addDoc(collection(db, 'registros_2024'), registro);
                
                // 2. Enviar copia a Drive (Backup para Jose)
                fetch(urlAppsScript, { method: 'POST', mode: 'no-cors', body: JSON.stringify(registro) });

                alert("‚úÖ Solicitud Radicada Exitosamente");
                e.target.reset();
                cambiarCategoria();
            } catch (err) { console.error(err); alert("Error al guardar"); }
            finally { btn.innerText = "RADICAR SOLICITUD"; btn.disabled = false; }
        });

        // --- L√ìGICA DE LINA (EVALUAR) ---
        async function cargarPendientesLina() {
            const tbody = document.getElementById('tabla-pendientes');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Cargando...</td></tr>';
            
            const q = query(collection(db, 'registros_2024'), orderBy('fecha_creacion', 'desc'));
            const querySnapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-blue-50 cursor-pointer transition";
                tr.onclick = () => abrirModalEvaluacion(docSnap.id, data);
                
                let estadoClass = data.estado === "APROBADO" ? "text-green-600 font-bold" : (data.estado === "NEGADO" ? "text-red-600 font-bold" : "text-yellow-600 font-bold");

                tr.innerHTML = `
                    <td class="p-3 text-sm">${data.fecha_solicitud}</td>
                    <td class="p-3 text-sm font-bold">${data.autor}</td>
                    <td class="p-3 text-sm">${data.titulo}</td>
                    <td class="p-3 text-sm">${data.categoria_pestana}</td>
                    <td class="p-3 text-sm ${estadoClass}">${data.estado}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        let idRegistroActual = null;

        window.abrirModalEvaluacion = (id, data) => {
            idRegistroActual = id;
            document.getElementById('modal-evaluacion').classList.remove('hidden');
            
            // Llenar datos de lectura (Lo que puso Jose)
            document.getElementById('info-titulo').innerText = data.titulo;
            document.getElementById('info-autor').innerText = data.autor;
            
            // Llenar datos de edici√≥n (Lo que pone Lina)
            document.getElementById('edit-estado').value = data.estado || "EN TR√ÅMITE";
            document.getElementById('edit-puntos').value = data.puntos_asignados || 0;
            document.getElementById('edit-acta').value = data.acta_ciarp || "";
            document.getElementById('edit-resolucion').value = data.resolucion || "";
            document.getElementById('edit-obs').value = data.observaciones || "";
        };

        window.cerrarModal = () => document.getElementById('modal-evaluacion').classList.add('hidden');

        window.guardarEvaluacion = async () => {
            if(!idRegistroActual) return;
            
            const actualizacion = {
                estado: document.getElementById('edit-estado').value,
                puntos_asignados: Number(document.getElementById('edit-puntos').value),
                acta_ciarp: document.getElementById('edit-acta').value,
                resolucion: document.getElementById('edit-resolucion').value,
                observaciones: document.getElementById('edit-obs').value
            };

            await updateDoc(doc(db, 'registros_2024', idRegistroActual), actualizacion);
            alert("‚úÖ Evaluaci√≥n Guardada");
            cerrarModal();
            cargarPendientesLina(); // Recargar tabla
        };

        // --- EXPORTAR TODO A EXCEL (Para Lina) ---
        window.descargarExcelCompleto = async () => {
            const querySnapshot = await getDocs(collection(db, 'registros_2024'));
            const datos = [];
            querySnapshot.forEach(doc => {
                const d = doc.data();
                datos.push(d); // Exporta todo, incluyendo puntos y actas
            });
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Base Maestra 2024");
            XLSX.writeFile(wb, "Reporte_Completo_CIARP.xlsx");
        };

        signInAnonymously(auth);
        window.onload = () => { /* Esperando login */ };
    </script>
</head>
<body class="bg-gray-100 font-sans h-screen flex flex-col">

    <div id="header-bg" class="bg-gray-800 text-white p-4 shadow-lg flex justify-between items-center transition-colors duration-500">
        <div>
            <h1 id="header-title" class="text-xl font-black tracking-wider">SISTEMA PRODUCTIVIDAD UQ</h1>
            <p class="text-[10px] opacity-75">Control de Acceso</p>
        </div>
        <button onclick="location.reload()" class="text-xs bg-white/20 px-3 py-1 rounded hover:bg-white/40">Cerrar Sesi√≥n</button>
    </div>

    <div id="pantalla-login" class="flex-1 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full">
            <h2 class="text-2xl font-bold text-gray-700 mb-8">Seleccione su Perfil</h2>
            
            <button onclick="iniciarSesion('JOSE')" class="w-full bg-[#003d2b] hover:bg-green-900 text-white p-4 rounded-xl mb-4 flex items-center justify-center gap-3 transition-transform hover:scale-105">
                <div class="text-left">
                    <div class="font-black text-lg">SOY JOSE</div>
                    <div class="text-xs opacity-80">Radicaci√≥n de Solicitudes</div>
                </div>
            </button>

            <button onclick="iniciarSesion('LINA')" class="w-full bg-blue-800 hover:bg-blue-900 text-white p-4 rounded-xl flex items-center justify-center gap-3 transition-transform hover:scale-105">
                <div class="text-left">
                    <div class="font-black text-lg">SOY LINA</div>
                    <div class="text-xs opacity-80">Evaluaci√≥n y Puntos CIARP</div>
                </div>
            </button>
        </div>
    </div>

    <div id="panel-jose" class="hidden flex-1 overflow-auto p-4 md:p-8">
        <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
            <div class="bg-green-50 p-4 border-b border-green-100">
                <h3 class="text-green-800 font-bold">Nueva Solicitud</h3>
            </div>
            <form id="form-jose" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500">Fecha Solicitud</label>
                    <input type="date" id="fecha_solicitud" required class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-gray-500">Categor√≠a</label>
                    <select id="categoria" onchange="cambiarCategoria()" class="w-full border p-2 rounded font-bold">
                        <option value="Publicac. Rev. Index">Art√≠culos Revistas</option>
                        <option value="Ponencias">Ponencias</option>
                        <option value="Libro Prod Investigaci√≥n">Libros</option>
                        <option value="Software">Software</option>
                        <option value="Direc. Tesis">Tesis</option>
                    </select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500">T√≠tulo del Producto</label>
                <input type="text" id="titulo" required class="w-full border p-2 rounded"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500">Docente</label>
                    <input type="text" id="autor" required class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-gray-500">C√©dula</label>
                    <input type="text" id="documento" required class="w-full border p-2 rounded"></div>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="block text-xs font-bold text-gray-500">Pa√≠s</label><input type="text" id="pais" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-gray-500">Programa</label><input type="text" id="programa" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-gray-500">Dedicaci√≥n</label>
                    <select id="dedicacion" class="w-full border p-2 rounded"><option>TC</option><option>MT</option><option>C√°tedra</option></select></div>
                    <input type="hidden" id="anio" value="2024"><input type="hidden" id="semestre" value="I"><input type="hidden" id="facultad" value="Ingenier√≠a">
                </div>

                <div id="campos-especificos" class="bg-gray-50 p-4 rounded border border-gray-200"></div>

                <button type="submit" id="btn-jose" class="w-full bg-[#003d2b] text-white py-3 rounded font-bold hover:bg-black">RADICAR SOLICITUD</button>
            </form>
        </div>
    </div>

    <div id="panel-lina" class="hidden flex-1 overflow-auto p-4 md:p-8">
        <div class="max-w-5xl mx-auto space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-blue-900">Bandeja de Pendientes</h2>
                <button onclick="descargarExcelCompleto()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 text-sm font-bold">üì• Descargar Reporte Maestro</button>
            </div>

            <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-blue-100 text-blue-900 uppercase text-xs font-bold">
                        <tr>
                            <th class="p-3">Fecha</th>
                            <th class="p-3">Docente</th>
                            <th class="p-3">T√≠tulo</th>
                            <th class="p-3">Categor√≠a</th>
                            <th class="p-3">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pendientes" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-evaluacion" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-blue-900 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold">Evaluar Solicitud</h3>
                <button onclick="cerrarModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-gray-50 p-3 rounded text-sm">
                    <p class="font-bold text-gray-500 text-xs">PRODUCTO</p>
                    <p id="info-titulo" class="font-black text-gray-800 mb-2"></p>
                    <p class="font-bold text-gray-500 text-xs">DOCENTE</p>
                    <p id="info-autor" class="text-gray-800"></p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-blue-900 mb-1">Estado CIARP</label>
                        <select id="edit-estado" class="w-full border-2 border-blue-200 p-2 rounded font-bold">
                            <option value="EN TR√ÅMITE">EN TR√ÅMITE</option>
                            <option value="APROBADO">APROBADO</option>
                            <option value="NEGADO">NEGADO</option>
                            <option value="DEVUELTO">DEVUELTO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-900 mb-1">Puntos Asignados</label>
                        <input type="number" id="edit-puntos" class="w-full border-2 border-blue-200 p-2 rounded font-bold text-right">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-blue-900 mb-1">Acta CIARP</label>
                        <input type="text" id="edit-acta" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-900 mb-1">Resoluci√≥n</label>
                        <input type="text" id="edit-resolucion" class="w-full border p-2 rounded">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-blue-900 mb-1">Observaciones T√©cnicas</label>
                    <textarea id="edit-obs" class="w-full border p-2 rounded h-20 text-sm"></textarea>
                </div>

                <button onclick="guardarEvaluacion()" class="w-full bg-blue-800 text-white py-3 rounded font-bold hover:bg-blue-900">GUARDAR EVALUACI√ìN</button>
            </div>
        </div>
    </div>

</body>
</html>

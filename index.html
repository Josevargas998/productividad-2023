<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Productividad UQ 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbqMf8ZOmqmbGTmr2tr8nziyUWKSE6OWg",
            authDomain: "uniquindio-produccion.firebaseapp.com",
            projectId: "uniquindio-produccion",
            storageBucket: "uniquindio-produccion.firebasestorage.app",
            messagingSenderId: "440871309124",
            appId: "1:440871309124:web:108be1894adaf6ecaf1111"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const urlAppsScript = "https://script.google.com/macros/s/AKfycbyp7NuQmqNN8YyvgjjwmgB1euP7NeNTEi6tZG_ErwZAvE_bMmaw94UdjyGuOrbdg6z-/exec";

        let rolActual = '';
        let idRegistroActual = null;
        let baseDocentes = [];

        const CONTRASE√ëAS = {
            'JOSE': 'jose2026',
            'LINA': 'lina2026'
        };

        // ==================== FUNCIONES DE LOGIN ====================
        window.intentarLogin = function(rol) {
            const password = document.getElementById(`password-${rol.toLowerCase()}`).value;
            
            if (!password) {
                alert("‚ö†Ô∏è Ingrese la contrase√±a");
                return;
            }
            
            if (password === CONTRASE√ëAS[rol]) {
                iniciarSesion(rol);
            } else {
                alert("‚ùå Contrase√±a incorrecta");
                document.getElementById(`password-${rol.toLowerCase()}`).value = '';
            }
        };

        function iniciarSesion(rol) {
            rolActual = rol;
            document.getElementById('pantalla-login').classList.add('hidden');
            
            if (rol === 'JOSE') {
                document.getElementById('panel-jose').classList.remove('hidden');
                document.getElementById('header-title').innerText = "SEGUIMIENTO DE SOLICITUDES (JOS√â)";
                document.getElementById('header-bg').classList.add('bg-green-800');
                cargarBaseDocentes();
                cambiarCategoria();
            } else {
                document.getElementById('panel-lina').classList.remove('hidden');
                document.getElementById('header-title').innerText = "COMPILADO Y LIQUIDACI√ìN (LINA)";
                document.getElementById('header-bg').classList.add('bg-blue-900');
                cargarBaseDocentes();
                cargarPendientesLina();
            }
        }

        window.cerrarSesion = function() {
            location.reload();
        };

        // ==================== CARGAR DOCENTES ====================
        async function cargarBaseDocentes() {
            try {
                console.log('üîÑ Cargando base de docentes...');
                
                const response = await fetch(urlAppsScript + '?action=obtenerDocentes');
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    baseDocentes = data;
                    
                    const datalistJose = document.getElementById('lista-docentes-jose');
                    const datalistLina = document.getElementById('lista-docentes-lina');
                    
                    if (datalistJose) {
                        datalistJose.innerHTML = '';
                        data.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.nombre;
                            datalistJose.appendChild(option);
                        });
                    }
                    
                    if (datalistLina) {
                        datalistLina.innerHTML = '';
                        data.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.nombre;
                            datalistLina.appendChild(option);
                        });
                    }
                    
                    console.log(`‚úÖ ${data.length} docentes cargados`);
                }
                    
            } catch (error) {
                console.error('‚ùå Error al cargar docentes:', error);
            }
        }

        // ==================== JOS√â: CAMBIAR CATEGOR√çA ====================
        window.cambiarCategoria = function() {
            const cat = document.getElementById('categoria').value;
            const container = document.getElementById('campos-especificos-jose');
            const inputClass = "w-full p-2 border border-gray-300 rounded";
            const labelClass = "block text-xs font-bold text-gray-600 mb-1";
            
            let html = '';

            if (cat === "Art√≠culos Indexados" || cat === "Art√≠culos No Indexados") {
                html = `
                    <div><label class="${labelClass}">Nombre del Art√≠culo</label>
                    <input type="text" id="nombre_articulo" class="${inputClass}" required></div>
                    <div><label class="${labelClass}">T√≠tulo de la Revista</label>
                    <input type="text" id="titulo_revista" class="${inputClass}"></div>
                `;
            } else if (cat.includes("Libro")) {
                html = `
                    <div><label class="${labelClass}">T√≠tulo del Libro</label>
                    <input type="text" id="titulo_libro" class="${inputClass}" required></div>
                    <div><label class="${labelClass}">√Årea de Conocimiento</label>
                    <input type="text" id="area_conocimiento" class="${inputClass}"></div>
                `;
            }

            container.innerHTML = html;
        };

        // ==================== JOS√â: ENVIAR SOLICITUD ====================
        window.enviarSolicitud = async function() {
            const categoria = document.getElementById('categoria').value;
            const anio = document.getElementById('anio').value;
            const semestre = document.getElementById('semestre').value;
            const fechaRecibido = document.getElementById('fecha-recibido').value;
            const autor = document.getElementById('autor').value;
            const programa = document.getElementById('programa').value;

            if (!categoria || !anio || !semestre || !fechaRecibido || !autor) {
                alert("‚ö†Ô∏è Complete los campos obligatorios");
                return;
            }

            let tituloProducto = '';
            if (categoria.includes("Art√≠culo")) {
                tituloProducto = document.getElementById('nombre_articulo')?.value || '';
            } else if (categoria.includes("Libro")) {
                tituloProducto = document.getElementById('titulo_libro')?.value || '';
            }

            if (!tituloProducto) {
                alert("‚ö†Ô∏è Complete el t√≠tulo del producto");
                return;
            }

            const btnEnviar = document.getElementById('btn-enviar-jose');
            btnEnviar.disabled = true;
            btnEnviar.innerText = "‚è≥ ENVIANDO...";

            try {
                const data = {
                    categoria: categoria,
                    anio: anio,
                    semestre: semestre,
                    fecha_recibido: fechaRecibido,
                    titulo_producto: tituloProducto,
                    autor: autor,
                    programa: programa,
                    doc_completa: document.getElementById('doc-completa')?.value || 'Pendiente',
                    estado_ciarp: 'Pendiente',
                    observaciones_jose: document.getElementById('observaciones-jose')?.value || '',
                    timestamp: new Date().toISOString(),
                    tipo_registro: "JOSE"
                };

                // Guardar en Firebase
                const docRef = await addDoc(collection(db, "solicitudes"), data);
                console.log("‚úÖ Firebase ID:", docRef.id);

                // Enviar a Google Sheets
                const response = await fetch(urlAppsScript, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.status === 'success' && result.fila) {
                    await updateDoc(doc(db, "solicitudes", docRef.id), {
                        _fila: result.fila,
                        _categoria: categoria
                    });
                }

                alert("‚úÖ Solicitud enviada correctamente");
                document.getElementById('form-jose').reset();
                document.getElementById('campos-especificos-jose').innerHTML = '';
                
            } catch (error) {
                console.error("‚ùå Error:", error);
                alert("‚ùå Error: " + error.message);
            } finally {
                btnEnviar.disabled = false;
                btnEnviar.innerText = "‚úÖ ENVIAR SOLICITUD";
            }
        };

        // ==================== LINA: CARGAR PENDIENTES ====================
        window.cargarPendientesLina = async function() {
            try {
                await signInAnonymously(auth);
                const q = query(collection(db, "solicitudes"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                const tbody = document.getElementById('tabla-pendientes-lina');
                tbody.innerHTML = '';

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const estadoColor = data.estado_ciarp === 'Aprobado' ? 'bg-green-100 text-green-800' : 
                                       data.estado_ciarp === 'No Aprobado' ? 'bg-red-100 text-red-800' : 
                                       'bg-yellow-100 text-yellow-800';
                    
                    const row = `<tr class="hover:bg-blue-50 cursor-pointer" onclick="abrirEvaluacion('${docSnap.id}')">
                        <td class="border px-2 py-2 text-xs">${data.categoria || ''}</td>
                        <td class="border px-2 py-2 text-xs font-semibold">${data.titulo_producto || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.autor || ''}</td>
                        <td class="border px-2 py-2 text-xs">${data.programa || ''}</td>
                        <td class="border px-2 py-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold ${estadoColor}">
                                ${data.estado_ciarp || 'Pendiente'}
                            </span>
                        </td>
                        <td class="border px-2 py-2 text-center text-xs">${data.puntaje_asignado || 0}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error("‚ùå Error al cargar pendientes:", error);
            }
        };

        // ==================== LINA: ABRIR EVALUACI√ìN ====================
        window.abrirEvaluacion = async function(id) {
            idRegistroActual = id;
            
            try {
                const docRef = doc(db, "solicitudes", id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    alert("‚ùå Registro no encontrado");
                    return;
                }

                const data = docSnap.data();
                
                document.getElementById('modal-evaluacion').classList.remove('hidden');
                
                // Datos de Jos√©
                document.getElementById('info-categoria').innerText = data.categoria || '';
                document.getElementById('info-titulo').innerText = data.titulo_producto || '';
                document.getElementById('info-autor').innerText = data.autor || '';
                document.getElementById('info-programa').innerText = data.programa || '';
                
                // Datos editables de Lina
                document.getElementById('edit-estado-ciarp').value = data.estado_ciarp || 'Pendiente';
                document.getElementById('edit-puntaje-eval1').value = data.puntaje_eval1 || '';
                document.getElementById('edit-puntaje-eval2').value = data.puntaje_eval2 || '';
                document.getElementById('edit-puntaje-final').value = data.puntaje_asignado || '';
                document.getElementById('edit-observaciones-lina').value = data.observaciones_lina || '';
                
            } catch (error) {
                console.error("‚ùå Error:", error);
                alert("‚ùå Error: " + error.message);
            }
        };

        // ==================== LINA: GUARDAR EVALUACI√ìN ====================
        window.guardarEvaluacion = async function() {
            if (!idRegistroActual) {
                alert("‚ùå No hay registro seleccionado");
                return;
            }

            try {
                const data = {
                    estado_ciarp: document.getElementById('edit-estado-ciarp').value,
                    puntaje_eval1: parseFloat(document.getElementById('edit-puntaje-eval1').value) || 0,
                    puntaje_eval2: parseFloat(document.getElementById('edit-puntaje-eval2').value) || 0,
                    puntaje_asignado: parseFloat(document.getElementById('edit-puntaje-final').value) || 0,
                    observaciones_lina: document.getElementById('edit-observaciones-lina').value,
                    timestamp_lina: new Date().toISOString(),
                    tipo_registro: "LINA"
                };

                // Obtener datos originales
                const docRef = doc(db, "solicitudes", idRegistroActual);
                const docSnap = await getDoc(docRef);
                const originalData = docSnap.data();

                // Actualizar Firebase
                await updateDoc(docRef, data);

                // Actualizar Google Sheets
                const sheetData = {
                    ...data,
                    titulo_producto: originalData.titulo_producto,
                    autor: originalData.autor,
                    _fila: originalData._fila,
                    categoria: originalData.categoria
                };

                await fetch(urlAppsScript, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sheetData)
                });

                alert("‚úÖ Evaluaci√≥n guardada correctamente");
                cerrarModal();
                cargarPendientesLina();
                
            } catch (error) {
                console.error("‚ùå Error:", error);
                alert("‚ùå Error: " + error.message);
            }
        };

        // ==================== CERRAR MODAL ====================
        window.cerrarModal = function() {
            document.getElementById('modal-evaluacion').classList.add('hidden');
            idRegistroActual = null;
        };

    </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- HEADER -->
    <div id="header-bg" class="text-white py-6 shadow-xl bg-gray-700">
        <div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
            <div>
                <h1 id="header-title" class="text-3xl font-bold">Sistema Productividad Acad√©mica</h1>
                <p class="text-sm opacity-90">Universidad del Quind√≠o - 2024</p>
            </div>
            <button onclick="cerrarSesion()" class="bg-white/20 hover:bg-white/30 px-6 py-2 rounded-lg font-bold">
                üîì CERRAR SESI√ìN
            </button>
        </div>
    </div>

    <!-- PANTALLA LOGIN -->
    <div id="pantalla-login" class="max-w-4xl mx-auto mt-16 px-4">
        <div class="bg-white rounded-3xl shadow-2xl p-12">
            <h2 class="text-4xl font-bold text-center text-gray-800 mb-12">Seleccione su Perfil</h2>
            
            <div class="grid grid-cols-2 gap-8">
                <!-- JOS√â -->
                <div class="bg-gradient-to-br from-green-800 to-green-600 p-8 rounded-2xl text-white shadow-xl">
                    <div class="text-center mb-6">
                        <div class="bg-white/20 w-24 h-24 rounded-full mx-auto flex items-center justify-center text-5xl mb-4">üìã</div>
                        <h3 class="text-2xl font-bold">JOS√â</h3>
                        <p class="text-sm opacity-90 mt-2">Seguimiento de Solicitudes</p>
                    </div>
                    <input type="password" id="password-jose" placeholder="Contrase√±a" 
                           class="w-full p-3 rounded-lg mb-4 text-gray-800"
                           onkeypress="if(event.key==='Enter') intentarLogin('JOSE')">
                    <button onclick="intentarLogin('JOSE')" 
                            class="w-full bg-white text-green-800 py-3 rounded-lg font-bold hover:bg-gray-100">
                        INGRESAR
                    </button>
                </div>

                <!-- LINA -->
                <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-8 rounded-2xl text-white shadow-xl">
                    <div class="text-center mb-6">
                        <div class="bg-white/20 w-24 h-24 rounded-full mx-auto flex items-center justify-center text-5xl mb-4">üìä</div>
                        <h3 class="text-2xl font-bold">LINA</h3>
                        <p class="text-sm opacity-90 mt-2">Compilado y Liquidaci√≥n</p>
                    </div>
                    <input type="password" id="password-lina" placeholder="Contrase√±a" 
                           class="w-full p-3 rounded-lg mb-4 text-gray-800"
                           onkeypress="if(event.key==='Enter') intentarLogin('LINA')">
                    <button onclick="intentarLogin('LINA')" 
                            class="w-full bg-white text-blue-900 py-3 rounded-lg font-bold hover:bg-gray-100">
                        INGRESAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL JOS√â -->
    <div id="panel-jose" class="hidden max-w-6xl mx-auto mt-8 px-4 pb-8">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã NUEVA SOLICITUD</h2>
            
            <form id="form-jose" class="space-y-6">
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Categor√≠a *</label>
                        <select id="categoria" onchange="cambiarCategoria()" class="w-full p-2 border rounded" required>
                            <option value="">Seleccionar...</option>
                            <option>Art√≠culos Indexados</option>
                            <option>Art√≠culos No Indexados</option>
                            <option>Libro Investigaci√≥n</option>
                            <option>Libro Texto</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">A√±o *</label>
                        <input type="number" id="anio" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Semestre *</label>
                        <select id="semestre" class="w-full p-2 border rounded" required>
                            <option value="">Seleccionar...</option>
                            <option>1</option>
                            <option>2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Fecha Recibido *</label>
                        <input type="date" id="fecha-recibido" class="w-full p-2 border rounded" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Autor/Docente *</label>
                        <input type="text" id="autor" list="lista-docentes-jose" class="w-full p-2 border rounded" required>
                        <datalist id="lista-docentes-jose"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Programa</label>
                        <input type="text" id="programa" class="w-full p-2 border rounded">
                    </div>
                </div>

                <div id="campos-especificos-jose" class="grid grid-cols-2 gap-4"></div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Documentaci√≥n Completa</label>
                    <select id="doc-completa" class="w-full p-2 border rounded">
                        <option>Pendiente</option>
                        <option>Completa</option>
                        <option>Incompleta</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Observaciones</label>
                    <textarea id="observaciones-jose" rows="3" class="w-full p-2 border rounded"></textarea>
                </div>

                <button type="button" id="btn-enviar-jose" onclick="enviarSolicitud()" 
                        class="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800">
                    ‚úÖ ENVIAR SOLICITUD
                </button>
            </form>
        </div>
    </div>

    <!-- PANEL LINA -->
    <div id="panel-lina" class="hidden max-w-7xl mx-auto mt-8 px-4 pb-8">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä SOLICITUDES PENDIENTES</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-blue-900 text-white">
                            <th class="border p-3 text-sm">Categor√≠a</th>
                            <th class="border p-3 text-sm">T√≠tulo</th>
                            <th class="border p-3 text-sm">Autor</th>
                            <th class="border p-3 text-sm">Programa</th>
                            <th class="border p-3 text-sm">Estado</th>
                            <th class="border p-3 text-sm">Puntaje</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pendientes-lina">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL EVALUACI√ìN -->
    <div id="modal-evaluacion" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üìù EVALUACI√ìN Y COMPILADO</h2>
                <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>

            <!-- Informaci√≥n de Jos√© (solo lectura) -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="font-bold text-gray-700 mb-3">üìã Informaci√≥n Original (Jos√©)</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>Categor√≠a:</strong> <span id="info-categoria"></span></div>
                    <div><strong>T√≠tulo:</strong> <span id="info-titulo"></span></div>
                    <div><strong>Autor:</strong> <span id="info-autor"></span></div>
                    <div><strong>Programa:</strong> <span id="info-programa"></span></div>
                </div>
            </div>

            <!-- Evaluaci√≥n de Lina (editable) -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Estado CIARP</label>
                    <select id="edit-estado-ciarp" class="w-full p-3 border-2 rounded-lg">
                        <option value="Pendiente">‚è≥ Pendiente</option>
                        <option value="Aprobado">‚úÖ Aprobado</option>
                        <option value="No Aprobado">‚ùå No Aprobado</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Puntaje Eval 1</label>
                        <input type="number" step="0.1" id="edit-puntaje-eval1" class="w-full p-3 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Puntaje Eval 2</label>
                        <input type="number" step="0.1" id="edit-puntaje-eval2" class="w-full p-3 border-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Puntaje Final</label>
                        <input type="number" step="0.1" id="edit-puntaje-final" class="w-full p-3 border-2 rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Observaciones T√©cnicas</label>
                    <textarea id="edit-observaciones-lina" rows="4" class="w-full p-3 border-2 rounded-lg"></textarea>
                </div>

                <button onclick="guardarEvaluacion()" 
                        class="w-full bg-blue-900 text-white py-4 rounded-lg font-bold hover:bg-blue-950 text-lg">
                    üíæ GUARDAR EVALUACI√ìN
                </button>
            </div>
        </div>
    </div>

</body>
</html>
